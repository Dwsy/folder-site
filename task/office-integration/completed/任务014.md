# 任务014: 添加安全验证模块，文件类型验证、魔数检查、XSS 防护

**状态**: Done
**优先级**: Medium
**预计时间**: 2h

**占用者**: task-executor
**锁定时间**: -

## 任务描述

添加安全验证模块，文件类型验证、魔数检查、XSS 防护

## 依赖任务

    - [x] 任务010 (状态: Done) - ✅ 已完成

**说明**: 只有所有标记的依赖任务状态为 Done 后，此任务才能开始执行。

## 验收标准

- [x] 功能正常运行
- [x] 代码通过 review

## 实施步骤

1. 阅读 task/office-integration/vscode-office-integration-architecture.md 了解安全设计
2. 阅读 task/office-integration/vscode-office-quickstart.md 查看代码示例
3. 实现文件类型验证
4. 实现文件魔数检查
5. 实现 XSS 防护（使用 DOMPurify）
6. 集成到渲染 API
7. 自测验证

## 完成内容

### 1. 创建的文件

- `src/security/types.ts` - 类型定义
- `src/security/file-type-validator.ts` - 文件类型验证模块
- `src/security/magic-number-validator.ts` - 魔数检查模块
- `src/security/xss-sanitizer.ts` - XSS 防护模块
- `src/security/index.ts` - 主模块，整合所有安全功能
- `src/security/README.md` - 使用文档
- `tests/security.test.ts` - 完整的单元测试

### 2. 修改的文件

- `plugins/office-renderer/ExcelRenderer.ts` - 集成安全验证

### 3. 实现的功能

#### 文件类型验证
- 支持的文件类型：Office 文档（.docx, .xlsx, .pptx, .pdf）、文本文件（.txt, .md, .json）、压缩文件（.zip, .rar, .7z）
- 白名单机制，可配置允许的文件类型
- 文件扩展名验证（区分大小写）

#### 魔数检查
- 支持 PDF、ZIP、OLE2、RAR、7z、GZIP 等文件类型的魔数验证
- 严格模式和宽松模式
- 防止文件扩展名伪造攻击
- 文件类型自动检测

#### XSS 防护
- 使用 DOMPurify 进行 HTML 清理
- 移除危险脚本标签
- 移除内联事件处理器
- 过滤危险的 URL 协议
- 可配置的允许标签和属性
- 支持 Office 文档渲染所需的所有 HTML 元素

#### 安全验证器（主模块）
- 一站式安全验证
- 文件验证：扩展名 + 魔数 + 文件大小
- HTML 清理：XSS 防护
- 可配置的严格程度
- 统计信息收集

### 4. 测试结果

所有 51 个测试全部通过：
- FileTypeValidator: 10 个测试
- MagicNumberValidator: 6 个测试
- XSSSanitizer: 12 个测试
- SecurityValidator: 14 个测试
- Factory Functions: 4 个测试
- Integration Tests: 2 个测试

### 5. 集成到渲染器

ExcelRenderer 已集成安全验证：
- 渲染前验证文件类型和魔数
- 渲染后清理 HTML 内容
- 提供清晰的错误信息

## 阻塞原因

**如果状态为 Blocked，在此记录阻塞原因**：
- 无

## 并行提示

- 依赖任务010已完成，可立即开始
- 可与任务009、任务011并行执行

## 备注

- 使用现有的 DOMPurify 和 lru-cache 依赖
- 遵循项目现有的代码风格和架构
- 添加了完整的注释和文档
- 所有测试通过

## 完成记录

- 开始时间: 2025-01-23 12:15
- 完成时间: 2025-01-23 13:30
- 耗时: 约 1.25 小时