# 任务015: Office 文档样式主题适配

**状态**: Done
**优先级**: Medium
**预计时间**: 2h
**实际时间**: 2h

**占用者**: task-executor
**开始时间**: 2026-01-23 12:30:00
**完成时间**: 2026-01-23 14:30:00

## 任务描述

实现 Office 文档样式主题适配，包括 CSS 变量注入和主题切换功能。

## 依赖任务

- [x] 任务001 (状态: Done) - 环境准备和依赖安装
- [x] 任务011 (状态: Done) - 添加 Office 样式文件

## 完成情况

### ✅ 已完成功能

#### 1. CSS 变量注入系统
- ✅ 创建 `src/client/lib/officeThemeInjector.ts`
  - `injectOfficeThemeVariables()` - 注入主题变量到容器
  - `clearOfficeThemeVariables()` - 清除主题变量
  - `getOfficeThemeVariables()` - 获取当前变量值
  - `extractOfficeThemeColors()` - 从文档提取主题色
  - `updateCSSVariables()` - 批量更新 CSS 变量
  - `syncThemeVariablesToChildren()` - 同步变量到子元素
  - `exportThemeAsJSON()` - 导出主题为 JSON
  - `importThemeFromJSON()` - 从 JSON 导入主题

#### 2. 主题类型定义
- ✅ 创建 `src/types/officeTheme.ts`
  - `OfficeThemeColors` - 主题颜色接口
  - `OfficeThemeMode` - 主题模式类型
  - `OfficeThemeConfig` - 主题配置接口
  - `DEFAULT_OFFICE_THEME_COLORS` - 默认浅色主题
  - `DARK_OFFICE_THEME_COLORS` - 默认深色主题
  - 验证和工具函数

#### 3. React Hooks
- ✅ 创建 `src/client/hooks/useOfficeTheme.tsx`
  - `useOfficeTheme()` - 主主题 Hook
  - `useOfficeThemeMode()` - 获取主题模式
  - `useOfficeThemeColors()` - 获取主题颜色
  - `useOfficeThemeUpdater()` - 获取更新函数
  - `useOfficeThemeExtractor()` - 主题提取功能
  - `useOfficeThemeReset()` - 主题重置功能
  - `useOfficeThemePersistence()` - 持久化管理

#### 4. UI 组件
- ✅ 创建 `src/client/components/office/OfficeThemeToggle.tsx`
  - `OfficeThemeToggle` - 标准主题切换按钮
  - `OfficeThemeToggleCompact` - 紧凑版切换按钮
  - `OfficeThemePicker` - 主题选择器

#### 5. 样式更新
- ✅ 更新 `src/client/styles/office.css`
  - 添加动态 CSS 变量定义
  - 支持从 useOfficeTheme Hook 注入变量
  - 保持与现有样式的兼容性

#### 6. 测试
- ✅ 创建 `src/client/hooks/__tests__/useOfficeTheme.test.tsx`
  - Hook 功能测试
  - 主题切换测试
  - CSS 变量更新测试
  - 持久化测试
  - 主题提取测试

#### 7. 文档
- ✅ 创建 `docs/office-theme-usage.md` - 使用指南
- ✅ 创建 `src/client/pages/OfficeThemeDemo.tsx` - 演示页面

## 验收标准

- [x] 功能正常运行，无错误
- [x] 代码通过 TypeScript 编译检查
- [x] 主题切换流畅
- [x] CSS 变量正确注入

## 技术实现细节

### CSS 变量设计

```css
:root {
  --office-primary-color: #0066cc;
  --office-secondary-color: #6b7280;
  --office-bg: #ffffff;
  --office-text: #0a0a0a;
  --office-border: #d4d4d4;
  /* ... 更多变量 */
}
```

### React Hooks API

```typescript
const {
  themeMode,
  themeColors,
  setThemeMode,
  toggleThemeMode,
  setThemeColors,
  updateVariable,
  extractThemeFromDocument,
  resetTheme,
} = useOfficeTheme({
  containerSelector: '.office-document',
  enablePersistence: true,
});
```

### 主题持久化

- 使用 localStorage 保存主题配置
- 支持跨标签页同步
- 自动数据迁移

### 主题提取

- 从 Office 文档样式中自动提取主题色
- 支持从计算样式中提取颜色值
- RGB/HEX 颜色格式转换

## 文件清单

### 新增文件
- `src/client/lib/officeThemeInjector.ts` (12.5 KB)
- `src/types/officeTheme.ts` (10.6 KB)
- `src/client/hooks/useOfficeTheme.tsx` (13.9 KB)
- `src/client/components/office/OfficeThemeToggle.tsx` (11.1 KB)
- `src/client/components/office/index.ts` (245 B)
- `src/client/hooks/__tests__/useOfficeTheme.test.tsx` (13.2 KB)
- `docs/office-theme-usage.md` (11.5 KB)
- `src/client/pages/OfficeThemeDemo.tsx` (12.7 KB)

### 修改文件
- `src/client/styles/office.css` - 添加动态 CSS 变量支持

## 测试结果

### TypeScript 编译
```
✅ 通过 - 无类型错误
```

### 功能测试
- ✅ 主题模式切换正常
- ✅ 主题颜色设置正常
- ✅ CSS 变量注入正常
- ✅ 主题持久化正常
- ✅ 主题提取正常

## 使用示例

### 基本用法

```tsx
import { useOfficeTheme } from '@/client/hooks/useOfficeTheme';
import { OfficeThemeToggle } from '@/client/components/office';

function MyOfficeViewer() {
  const { themeMode, setThemeMode } = useOfficeTheme();

  return (
    <div className="office-document">
      <OfficeThemeToggle />
      {/* Office 文档内容 */}
    </div>
  );
}
```

### 高级用法

```tsx
const {
  themeMode,
  themeColors,
  setThemeColors,
  updateVariable,
  extractThemeFromDocument,
} = useOfficeTheme({
  containerSelector: '#my-viewer',
  enablePersistence: true,
  onThemeChange: (mode, colors) => {
    console.log('Theme changed:', mode, colors);
  },
});

// 自定义主题颜色
setThemeColors({
  primaryColor: '#ff0000',
  backgroundColor: '#000000',
});

// 更新单个变量
updateVariable('--office-primary-color', '#00ff00');

// 从文档提取主题
extractThemeFromDocument(document.querySelector('.excel-workbook'));
```

## 后续建议

1. **性能优化**
   - 实现虚拟滚动支持大表格
   - 优化主题切换性能
   - 添加 Web Worker 支持

2. **功能扩展**
   - 支持更多主题预设
   - 添加主题导入/导出功能
   - 支持自定义主题编辑器

3. **测试完善**
   - 添加 E2E 测试
   - 添加性能测试
   - 添加可访问性测试

## 备注

- 所有代码已通过 TypeScript 类型检查
- 遵循项目现有代码风格
- 添加了完整的 JSDoc 注释
- 提供了详细的使用文档和演示页面

## 完成记录

- **开始时间**: 2026-01-23 12:30:00
- **完成时间**: 2026-01-23 14:30:00
- **实际耗时**: 2 小时
- **代码行数**: 约 1000+ 行
- **文件数量**: 8 个新文件，1 个修改文件