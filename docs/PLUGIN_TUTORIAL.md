# Folder-Site æ’ä»¶å¼€å‘æ•™ç¨‹

> ä»é›¶å¼€å§‹å­¦ä¹ å¦‚ä½•ä¸º Folder-Site å¼€å‘é«˜è´¨é‡æ’ä»¶

## ç›®å½•

- [å¼•è¨€](#å¼•è¨€)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ’ä»¶åŸºç¡€](#æ’ä»¶åŸºç¡€)
- [API è¯¦è§£](#api-è¯¦è§£)
- [å¸¸è§æ’ä»¶æ¨¡å¼](#å¸¸è§æ’ä»¶æ¨¡å¼)
- [è¿›é˜¶ä¸»é¢˜](#è¿›é˜¶ä¸»é¢˜)
- [è°ƒè¯•æŒ‡å—](#è°ƒè¯•æŒ‡å—)
- [æµ‹è¯•æŒ‡å—](#æµ‹è¯•æŒ‡å—)
- [å‘å¸ƒæŒ‡å—](#å‘å¸ƒæŒ‡å—)
- [é™„å½•](#é™„å½•)

---

## å¼•è¨€

### æ’ä»¶ç³»ç»Ÿæ¦‚è¿°

Folder-Site æä¾›äº†ä¸€ä¸ªå¼ºå¤§ä¸”çµæ´»çš„æ’ä»¶ç³»ç»Ÿï¼Œå…è®¸å¼€å‘è€…æ‰©å±•ç³»ç»ŸåŠŸèƒ½è€Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç ã€‚æ’ä»¶ç³»ç»Ÿå…·æœ‰ä»¥ä¸‹æ ¸å¿ƒç‰¹æ€§ï¼š

- **ç±»å‹å®‰å…¨**: å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰å’Œç±»å‹æ£€æŸ¥
- **ç”Ÿå‘½å‘¨æœŸç®¡ç†**: æ¸…æ™°çš„åˆå§‹åŒ–ã€æ¿€æ´»ã€åœç”¨å’Œé”€æ¯æµç¨‹
- **äº‹ä»¶é©±åŠ¨**: åŸºäºäº‹ä»¶çš„æ’ä»¶é—´é€šä¿¡æœºåˆ¶
- **ä¾èµ–ç®¡ç†**: è‡ªåŠ¨è§£æå’Œç®¡ç†æ’ä»¶ä¾èµ–å…³ç³»
- **èµ„æºéš”ç¦»**: æ’ä»¶æ‹¥æœ‰ç‹¬ç«‹çš„å­˜å‚¨å’Œé…ç½®ç©ºé—´
- **çƒ­åŠ è½½**: æ”¯æŒè¿è¡Œæ—¶åŠ è½½å’Œå¸è½½æ’ä»¶

### ä¸ºä»€ä¹ˆè¦å¼€å‘æ’ä»¶

å¼€å‘æ’ä»¶å¯ä»¥è®©ä½ ï¼š

1. **æ‰©å±•æ¸²æŸ“èƒ½åŠ›**: æ·»åŠ æ–°çš„å†…å®¹æ¸²æŸ“å™¨ï¼ˆå¦‚å›¾è¡¨ã€å…¬å¼ã€åœ°å›¾ï¼‰
2. **è‡ªå®šä¹‰å¯¼å‡ºæ ¼å¼**: æ”¯æŒå¯¼å‡ºä¸º PDFã€EPUBã€Word ç­‰æ ¼å¼
3. **å¢å¼ºæœç´¢åŠŸèƒ½**: æ·»åŠ æ–°çš„æœç´¢ç®—æ³•æˆ–ç´¢å¼•ç­–ç•¥
4. **é›†æˆå¤–éƒ¨æœåŠ¡**: è¿æ¥ç¬¬ä¸‰æ–¹ API æˆ–æœåŠ¡
5. **è‡ªå®šä¹‰ UI**: æ·»åŠ è‡ªå®šä¹‰é¢æ¿ã€å·¥å…·æ æˆ–èœå•é¡¹
6. **è‡ªåŠ¨åŒ–å·¥ä½œæµ**: å®ç°è‡ªåŠ¨åŒ–çš„æ–‡æ¡£å¤„ç†æµç¨‹

### ç›®æ ‡è¯»è€…

æœ¬æ•™ç¨‹é€‚åˆä»¥ä¸‹å¼€å‘è€…ï¼š

- ç†Ÿæ‚‰ TypeScript æˆ– JavaScript çš„å¼€å‘è€…
- äº†è§£ Node.js è¿è¡Œæ—¶å’Œæ¨¡å—ç³»ç»Ÿ
- å¯¹æ–‡æ¡£ç”Ÿæˆã€é™æ€ç½‘ç«™æ„å»ºæ„Ÿå…´è¶£çš„å¼€å‘è€…
- å¸Œæœ›æ‰©å±• Folder-Site åŠŸèƒ½çš„å¼€å‘è€…

### å‰ç½®çŸ¥è¯†

åœ¨å¼€å§‹ä¹‹å‰ï¼Œä½ åº”è¯¥å…·å¤‡ï¼š

- TypeScript åŸºç¡€çŸ¥è¯†ï¼ˆç±»å‹ã€æ¥å£ã€ç±»ï¼‰
- Node.js å’ŒåŒ…ç®¡ç†å™¨ï¼ˆnpm æˆ– Bunï¼‰çš„ä½¿ç”¨ç»éªŒ
- åŸºæœ¬çš„å¼‚æ­¥ç¼–ç¨‹ç†è§£ï¼ˆPromiseã€async/awaitï¼‰
- ç†Ÿæ‚‰ Markdown è¯­æ³•ï¼ˆå¯é€‰ï¼‰

### æŠ€æœ¯æ ˆ

- **è¯­è¨€**: TypeScript 5.6+
- **è¿è¡Œæ—¶**: Node.js 18+ / Bun 1.0+
- **åŒ…ç®¡ç†**: npm / Bun
- **æ„å»ºå·¥å…·**: TypeScript Compiler (tsc)

---

## å¿«é€Ÿå¼€å§‹

### æœ€ç®€å•çš„æ’ä»¶ç¤ºä¾‹ï¼ˆHello Worldï¼‰

è®©æˆ‘ä»¬ä»ä¸€ä¸ªæœ€ç®€å•çš„ Hello World æ’ä»¶å¼€å§‹ï¼Œè¿™ä¸ªæ’ä»¶åœ¨åˆå§‹åŒ–æ—¶è¾“å‡ºä¸€æ¡æ—¥å¿—æ¶ˆæ¯ã€‚

#### é¡¹ç›®ç»“æ„

```
hello-world-plugin/
â”œâ”€â”€ manifest.json          # æ’ä»¶æ¸…å•
â”œâ”€â”€ package.json           # npm é…ç½®
â”œâ”€â”€ tsconfig.json          # TypeScript é…ç½®
â”œâ”€â”€ src/
â”‚   â””â”€â”€ index.ts           # æ’ä»¶å…¥å£
â””â”€â”€ dist/                  # ç¼–è¯‘è¾“å‡ºï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
```

#### æ­¥éª¤ 1: åˆ›å»ºé¡¹ç›®

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir hello-world-plugin
cd hello-world-plugin

# åˆå§‹åŒ– npm é¡¹ç›®
npm init -y
```

#### æ­¥éª¤ 2: é…ç½® package.json

```json
{
  "name": "@folder-site/hello-world-plugin",
  "version": "1.0.0",
  "description": "A simple Hello World plugin",
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "scripts": {
    "build": "tsc",
    "dev": "tsc --watch",
    "prepublishOnly": "npm run build"
  },
  "keywords": ["folder-site", "plugin"],
  "author": "Your Name",
  "license": "MIT",
  "devDependencies": {
    "typescript": "^5.6.0"
  },
  "peerDependencies": {
    "folder-site": ">=1.0.0"
  }
}
```

#### æ­¥éª¤ 3: é…ç½® TypeScript

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "lib": ["ES2022"],
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "tests"]
}
```

#### æ­¥éª¤ 4: åˆ›å»ºæ’ä»¶æ¸…å•

```json
{
  "id": "hello-world",
  "name": "Hello World Plugin",
  "version": "1.0.0",
  "description": "A simple Hello World plugin",
  "author": {
    "name": "Your Name",
    "email": "your@example.com"
  },
  "license": "MIT",
  "entry": "dist/index.js",
  "capabilities": [
    {
      "type": "custom",
      "name": "hello-world",
      "version": "1.0.0"
    }
  ],
  "engines": {
    "folderSite": ">=1.0.0"
  }
}
```

#### æ­¥éª¤ 5: å®ç°æ’ä»¶

```typescript
// src/index.ts
import type {
  Plugin,
  PluginManifest,
  PluginContext,
  PluginStatus
} from '../../types/plugin.js';

/**
 * Hello World æ’ä»¶
 * 
 * è¿™æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„æ’ä»¶ç¤ºä¾‹ï¼Œä»…å®ç°åŸºæœ¬çš„åˆå§‹åŒ–åŠŸèƒ½
 */
export class HelloWorldPlugin implements Plugin {
  // æ’ä»¶å…ƒæ•°æ®ï¼ˆåªè¯»å±æ€§ï¼‰
  readonly id: string = 'hello-world';
  readonly name: string = 'Hello World Plugin';
  readonly version: string = '1.0.0';
  readonly manifest: PluginManifest;
  readonly status: PluginStatus = 'discovered';

  // æ’ä»¶çŠ¶æ€å’Œé”™è¯¯
  private context?: PluginContext;

  constructor(manifest: PluginManifest) {
    this.manifest = manifest;
  }

  /**
   * åˆå§‹åŒ–æ’ä»¶
   * 
   * è¿™æ˜¯æ’ä»¶ç”Ÿå‘½å‘¨æœŸçš„ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼Œå®¿ä¸»ç¯å¢ƒä¼šåœ¨åŠ è½½æ’ä»¶åè°ƒç”¨æ­¤æ–¹æ³•
   * 
   * @param context - æ’ä»¶ä¸Šä¸‹æ–‡ï¼Œæä¾›å¯¹å®¿ä¸»ç¯å¢ƒçš„è®¿é—®
   */
  async initialize(context: PluginContext): Promise<void> {
    this.context = context;

    // è¾“å‡ºæ—¥å¿—
    context.logger.info('ğŸ‰ Hello World Plugin initialized!');
    context.logger.debug('Folder-Site version:', context.app.version);
    context.logger.debug('Environment:', context.app.environment);
  }

  /**
   * æ¿€æ´»æ’ä»¶
   * 
   * æ’ä»¶åˆå§‹åŒ–åï¼Œå®¿ä¸»ç¯å¢ƒä¼šè°ƒç”¨æ­¤æ–¹æ³•æ¿€æ´»æ’ä»¶
   */
  async activate(): Promise<void> {
    this.context?.logger.info('Hello World Plugin activated! ğŸš€');
  }

  /**
   * åœç”¨æ’ä»¶
   * 
   * å½“æ’ä»¶ä¸å†éœ€è¦æ—¶ï¼Œå®¿ä¸»ç¯å¢ƒä¼šè°ƒç”¨æ­¤æ–¹æ³•
   */
  async deactivate(): Promise<void> {
    this.context?.logger.info('Hello World Plugin deactivated ğŸ‘‹');
  }

  /**
   * é”€æ¯æ’ä»¶
   * 
   * æ¸…ç†æ’ä»¶å ç”¨çš„æ‰€æœ‰èµ„æº
   */
  async dispose(): Promise<void> {
    this.context?.logger.info('Hello World Plugin disposed â™»ï¸');
    this.context = undefined;
  }
}

// é»˜è®¤å¯¼å‡ºæ’ä»¶ç±»
export default HelloWorldPlugin;
```

#### æ­¥éª¤ 6: æ„å»ºæ’ä»¶

```bash
# å®‰è£…ä¾èµ–
npm install

# æ„å»ºæ’ä»¶
npm run build
```

æ„å»ºæˆåŠŸåï¼Œä½ ä¼šçœ‹åˆ° `dist/` ç›®å½•ä¸‹ç”Ÿæˆäº†ç¼–è¯‘åçš„æ–‡ä»¶ï¼š

```
dist/
â”œâ”€â”€ index.js
â”œâ”€â”€ index.d.ts
â””â”€â”€ index.js.map
```

#### æ­¥éª¤ 7: æµ‹è¯•æ’ä»¶

å°†æ’ä»¶å¤åˆ¶åˆ°ä½ çš„ Folder-Site é¡¹ç›®çš„ `plugins/` ç›®å½•ï¼š

```bash
# å¤åˆ¶æ’ä»¶åˆ° Folder-Site é¡¹ç›®
cp -r hello-world-plugin /path/to/folder-site/plugins/
```

ç„¶ååœ¨ Folder-Site é¡¹ç›®ä¸­è¿è¡Œï¼š

```bash
# å¯åŠ¨ Folder-Site
bun run dev

# æˆ–
npm start
```

ä½ å°†åœ¨æ§åˆ¶å°è¾“å‡ºä¸­çœ‹åˆ°ï¼š

```
[info] ğŸ‰ Hello World Plugin initialized!
[debug] Folder-Site version: 1.0.0
[debug] Environment: development
[info] Hello World Plugin activated! ğŸš€
```

### æ’ä»¶ç”Ÿå‘½å‘¨æœŸå¯è§†åŒ–

```mermaid
stateDiagram-v2
    [*] --> Discovered: æ’ä»¶è¢«æ‰«æ
    Discovered --> Validated: æ¸…å•éªŒè¯
    Validated --> Loading: åŠ è½½ä»£ç 
    Loading --> Loaded: åŠ è½½å®Œæˆ
    Loaded --> Activating: è°ƒç”¨ initialize()
    Activating --> Active: è°ƒç”¨ activate()
    Active --> Deactivating: è°ƒç”¨ deactivate()
    Deactivating --> Inactive: åœç”¨å®Œæˆ
    Inactive --> Activating: é‡æ–°æ¿€æ´»
    Active --> Disposing: è°ƒç”¨ dispose()
    Disposing --> [*]: é”€æ¯å®Œæˆ

    note right of Activating
        initialize() æ–¹æ³•
        åœ¨æ­¤é˜¶æ®µå®Œæˆ
    end note

    note right of Deactivating
        deactivate() æ–¹æ³•
        åœ¨æ­¤é˜¶æ®µå®Œæˆ
    end note

    note right of Disposing
        dispose() æ–¹æ³•
        åœ¨æ­¤é˜¶æ®µå®Œæˆ
    end note
```

---

## æ’ä»¶åŸºç¡€

### æ’ä»¶çš„ç”Ÿå‘½å‘¨æœŸ

æ’ä»¶çš„ç”Ÿå‘½å‘¨æœŸåŒ…å«ä»¥ä¸‹çŠ¶æ€å’Œè½¬æ¢ï¼š

#### çŠ¶æ€è¯´æ˜

| çŠ¶æ€ | è¯´æ˜ | å¯æ‰§è¡Œçš„æ“ä½œ |
|------|------|-------------|
| `discovered` | æ’ä»¶å·²è¢«æ‰«æä½†æœªéªŒè¯ | - |
| `validated` | æ’ä»¶æ¸…å•å·²éªŒè¯é€šè¿‡ | - |
| `loading` | æ­£åœ¨åŠ è½½æ’ä»¶ä»£ç  | - |
| `loaded` | æ’ä»¶ä»£ç å·²åŠ è½½ï¼Œç­‰å¾…åˆå§‹åŒ– | - |
| `activating` | æ­£åœ¨è°ƒç”¨ `initialize()` æ–¹æ³• | åˆå§‹åŒ–èµ„æº |
| `active` | æ’ä»¶å·²æ¿€æ´»å¹¶è¿è¡Œ | æ‰§è¡Œä¸»è¦åŠŸèƒ½ |
| `deactivating` | æ­£åœ¨è°ƒç”¨ `deactivate()` æ–¹æ³• | æš‚åœåŠŸèƒ½ |
| `inactive` | æ’ä»¶å·²åœç”¨ä½†ä»åŠ è½½ | - |
| `error` | æ’ä»¶å‘ç”Ÿé”™è¯¯ | - |

#### ç”Ÿå‘½å‘¨æœŸæ–¹æ³•

```typescript
interface Plugin {
  // åˆå§‹åŒ–æ’ä»¶ï¼ˆå¿…éœ€ï¼‰
  initialize(context: PluginContext): Promise<void>;

  // æ¿€æ´»æ’ä»¶ï¼ˆå¿…éœ€ï¼‰
  activate(): Promise<void>;

  // åœç”¨æ’ä»¶ï¼ˆå¿…éœ€ï¼‰
  deactivate(): Promise<void>;

  // é”€æ¯æ’ä»¶ï¼ˆå¿…éœ€ï¼‰
  dispose(): Promise<void>;
}
```

#### æ–¹æ³•è°ƒç”¨æ—¶æœº

```mermaid
sequenceDiagram
    participant HS as Folder-Site
    participant P as Plugin

    HS->>P: load()
    HS->>P: initialize(context)
    Note over P: åˆ›å»ºèµ„æº<br/>æ³¨å†ŒåŠŸèƒ½<br/>è®¢é˜…äº‹ä»¶
    P-->>HS: initialized

    HS->>P: activate()
    Note over P: å¯åŠ¨åŠŸèƒ½<br/>å¼€å§‹å·¥ä½œ
    P-->>HS: activated

    Note over P: æ’ä»¶æ­£å¸¸è¿è¡Œ...

    HS->>P: deactivate()
    Note over P: æš‚åœåŠŸèƒ½<br/>ä¿å­˜çŠ¶æ€
    P-->>HS: deactivated

    HS->>P: dispose()
    Note over P: æ¸…ç†èµ„æº<br/>é‡Šæ”¾å†…å­˜
    P-->>HS: disposed
```

### æ’ä»¶é…ç½®æ–‡ä»¶ç»“æ„

æ’ä»¶æ¸…å• `manifest.json` å®šä¹‰äº†æ’ä»¶çš„æ‰€æœ‰å…ƒæ•°æ®å’Œé…ç½®ã€‚

#### å®Œæ•´çš„æ¸…å•ç¤ºä¾‹

```json
{
  "id": "com.example.my-plugin",
  "name": "My Plugin",
  "version": "1.0.0",
  "description": "A comprehensive plugin example",
  "author": {
    "name": "John Doe",
    "email": "john@example.com",
    "url": "https://example.com"
  },
  "license": "MIT",
  "entry": "dist/index.js",
  "main": "dist/index.js",
  "dependencies": {
    "lodash": "^4.17.21"
  },
  "peerDependencies": {
    "folder-site": ">=1.0.0"
  },
  "capabilities": [
    {
      "type": "renderer",
      "name": "my-renderer",
      "version": "1.0.0",
      "constraints": {
        "supportedFormats": ["svg", "png"]
      }
    }
  ],
  "hooks": {
    "onLoad": "dist/hooks/onLoad.js",
    "onUnload": "dist/hooks/onUnload.js",
    "onActivate": "dist/hooks/onActivate.js",
    "onDeactivate": "dist/hooks/onDeactivate.js"
  },
  "options": {
    "type": "object",
    "properties": {
      "apiKey": {
        "type": "string",
        "description": "API key for external service"
      },
      "timeout": {
        "type": "number",
        "description": "Request timeout in milliseconds",
        "default": 5000,
        "minimum": 1000,
        "maximum": 30000
      },
      "enableCache": {
        "type": "boolean",
        "description": "Enable response caching",
        "default": true
      }
    },
    "required": ["apiKey"]
  },
  "engines": {
    "folderSite": ">=1.0.0",
    "node": ">=18.0.0"
  },
  "contributes": {
    "ui": [
      {
        "id": "my-panel",
        "type": "panel",
        "name": "MyPanel",
        "position": "right",
        "priority": 100
      }
    ],
    "commands": [
      {
        "id": "my-plugin.refresh",
        "title": "Refresh",
        "icon": "refresh",
        "keybinding": "Cmd+R"
      }
    ]
  }
}
```

#### å­—æ®µè¯¦ç»†è¯´æ˜

##### å¿…éœ€å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `id` | string | æ’ä»¶å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆæ¨èåå‘åŸŸåæ ¼å¼ï¼‰ | `com.example.my-plugin` |
| `name` | string | æ’ä»¶æ˜¾ç¤ºåç§° | `My Plugin` |
| `version` | string | è¯­ä¹‰åŒ–ç‰ˆæœ¬å·ï¼ˆsemverï¼‰ | `1.0.0` |
| `entry` | string | æ’ä»¶å…¥å£æ–‡ä»¶è·¯å¾„ | `dist/index.js` |
| `capabilities` | array | æ’ä»¶èƒ½åŠ›å£°æ˜ | è§ä¸‹æ–¹ |

##### å¯é€‰å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `description` | string | æ’ä»¶æè¿° |
| `author` | object | ä½œè€…ä¿¡æ¯ï¼ˆname, email, urlï¼‰ |
| `license` | string | è®¸å¯è¯ï¼ˆSPDX æ ‡è¯†ç¬¦ï¼‰ |
| `main` | string | ä¸»æ¨¡å—è·¯å¾„ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰ |
| `dependencies` | object | æ’ä»¶ä¾èµ– |
| `peerDependencies` | object | å®¿ä¸»ç¯å¢ƒä¾èµ– |
| `hooks` | object | ç”Ÿå‘½å‘¨æœŸé’©å­é…ç½® |
| `options` | object | æ’ä»¶é…ç½®é¡¹æ¨¡å¼ |
| `engines` | object | å…¼å®¹æ€§è¦æ±‚ |
| `contributes` | object | è´¡çŒ®ç‚¹å£°æ˜ |

##### èƒ½åŠ›ç±»å‹ï¼ˆcapabilitiesï¼‰

```json
{
  "capabilities": [
    {
      "type": "renderer",
      "name": "mermaid",
      "version": "1.0.0",
      "constraints": {
        "supportedFormats": ["svg", "png"],
        "supportedThemes": ["light", "dark"]
      }
    }
  ]
}
```

æ”¯æŒçš„èƒ½åŠ›ç±»å‹ï¼š

- `renderer`: å†…å®¹æ¸²æŸ“å™¨
- `transformer`: å†…å®¹è½¬æ¢å™¨
- `exporter`: å¯¼å‡ºå™¨
- `storage`: å­˜å‚¨æä¾›è€…
- `ui`: UI ç»„ä»¶
- `custom`: è‡ªå®šä¹‰èƒ½åŠ›

### æ’ä»¶å…¥å£ç‚¹å’Œåˆå§‹åŒ–

#### å…¥å£ç‚¹ç»“æ„

æ’ä»¶çš„å…¥å£æ–‡ä»¶å¿…é¡»å¯¼å‡ºä¸€ä¸ªå®ç° `Plugin` æ¥å£çš„ç±»ï¼š

```typescript
// src/index.ts
import type { Plugin, PluginManifest, PluginContext } from '../../types/plugin.js';

export class MyPlugin implements Plugin {
  readonly id: string;
  readonly name: string;
  readonly version: string;
  readonly manifest: PluginManifest;
  private context?: PluginContext;

  constructor(manifest: PluginManifest) {
    this.id = manifest.id;
    this.name = manifest.name;
    this.version = manifest.version;
    this.manifest = manifest;
  }

  async initialize(context: PluginContext): Promise<void> {
    this.context = context;
    // åˆå§‹åŒ–é€»è¾‘
  }

  async activate(): Promise<void> {
    // æ¿€æ´»é€»è¾‘
  }

  async deactivate(): Promise<void> {
    // åœç”¨é€»è¾‘
  }

  async dispose(): Promise<void> {
    // æ¸…ç†é€»è¾‘
  }
}

// é»˜è®¤å¯¼å‡ºæ’ä»¶ç±»
export default MyPlugin;
```

#### åˆå§‹åŒ–æœ€ä½³å®è·µ

```typescript
async initialize(context: PluginContext): Promise<void> {
  this.context = context;

  try {
    // 1. è®°å½•åˆå§‹åŒ–å¼€å§‹
    context.logger.debug('Starting initialization...');

    // 2. è·å–é…ç½®
    const config = this.loadConfig(context);

    // 3. åˆå§‹åŒ–èµ„æº
    await this.initializeResources(config);

    // 4. æ³¨å†ŒåŠŸèƒ½
    this.registerFeatures(context);

    // 5. è®¢é˜…äº‹ä»¶
    this.setupEventListeners(context);

    // 6. è®°å½•åˆå§‹åŒ–å®Œæˆ
    context.logger.info('Plugin initialized successfully');
  } catch (error) {
    context.logger.error('Initialization failed:', error);
    throw error;
  }
}
```

---

## API è¯¦è§£

### æ ¸å¿ƒæ¥å£å’Œç±»

#### Plugin æ¥å£

æ‰€æœ‰æ’ä»¶å¿…é¡»å®ç°çš„æ ¸å¿ƒæ¥å£ï¼š

```typescript
interface Plugin {
  // åªè¯»å±æ€§
  readonly id: string;
  readonly name: string;
  readonly version: string;
  readonly manifest: PluginManifest;
  readonly status: PluginStatus;
  readonly error?: Error;

  // ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
  initialize(context: PluginContext): Promise<void>;
  activate(): Promise<void>;
  deactivate(): Promise<void>;
  dispose(): Promise<void>;
}
```

#### PluginContext æ¥å£

æ’ä»¶ä¸Šä¸‹æ–‡æä¾›å¯¹å®¿ä¸»ç¯å¢ƒçš„è®¿é—®ï¼š

```typescript
interface PluginContext {
  // å®¿ä¸»ç¯å¢ƒä¿¡æ¯
  readonly app: {
    readonly version: string;
    readonly environment: 'development' | 'production';
    readonly rootPath: string;
    readonly configPath: string;
  };

  // æœåŠ¡è®¿é—®
  readonly services: PluginServices;

  // äº‹ä»¶ç³»ç»Ÿ
  readonly events: PluginEventEmitter;

  // æ—¥å¿—ç³»ç»Ÿ
  readonly logger: PluginLogger;

  // æ’ä»¶å­˜å‚¨
  readonly storage: PluginStorage;

  // å·¥å…·å‡½æ•°
  readonly utils: PluginUtils;

  // é…ç½®
  readonly config: PluginConfig;
}
```

#### ä½¿ç”¨ç¤ºä¾‹

```typescript
async initialize(context: PluginContext): Promise<void> {
  this.context = context;

  // è®¿é—®åº”ç”¨ä¿¡æ¯
  console.log('Folder-Site version:', context.app.version);
  console.log('Environment:', context.app.environment);
  console.log('Root path:', context.app.rootPath);

  // ä½¿ç”¨æ—¥å¿—
  context.logger.debug('Debug message');
  context.logger.info('Info message');
  context.logger.warn('Warning message');
  context.logger.error('Error message', new Error('Something went wrong'));

  // ä½¿ç”¨å­˜å‚¨
  context.storage.set('lastRun', Date.now());
  const lastRun = context.storage.get('lastRun');

  // ä½¿ç”¨é…ç½®
  const apiKey = context.config.get('apiKey');
  context.config.set('apiKey', 'new-key');

  // è®¢é˜…äº‹ä»¶
  context.events.on('file:changed', (data) => {
    context.logger.info('File changed:', data.path);
  });

  // å‘å¸ƒäº‹ä»¶
  context.events.emit('my-plugin:ready', { version: '1.0.0' });
}
```

### å¯ç”¨çš„é’©å­ï¼ˆhooksï¼‰å’Œäº‹ä»¶

#### ç”Ÿå‘½å‘¨æœŸé’©å­

æ’ä»¶å¯ä»¥åœ¨æ¸…å•ä¸­å£°æ˜ç”Ÿå‘½å‘¨æœŸé’©å­ï¼š

```json
{
  "hooks": {
    "onLoad": "dist/hooks/onLoad.js",
    "onUnload": "dist/hooks/onUnload.js",
    "onActivate": "dist/hooks/onActivate.js",
    "onDeactivate": "dist/hooks/onDeactivate.js"
  }
}
```

#### é’©å­å®ç°ç¤ºä¾‹

```typescript
// src/hooks/onLoad.ts
export default async function onLoad(context: PluginContext): Promise<void> {
  context.logger.info('Plugin loaded');
  // åŠ è½½æ—¶çš„åˆå§‹åŒ–é€»è¾‘
}
```

```typescript
// src/hooks/onUnload.ts
export default async function onUnload(context: PluginContext): Promise<void> {
  context.logger.info('Plugin unloaded');
  // å¸è½½æ—¶çš„æ¸…ç†é€»è¾‘
}
```

#### ç³»ç»Ÿäº‹ä»¶

æ’ä»¶å¯ä»¥è®¢é˜…ä»¥ä¸‹ç³»ç»Ÿäº‹ä»¶ï¼š

| äº‹ä»¶åç§° | æ•°æ®ç±»å‹ | è¯´æ˜ |
|---------|---------|------|
| `file:changed` | `{ path: string, type: 'created' \| 'updated' \| 'deleted' }` | æ–‡ä»¶å˜åŒ– |
| `file:created` | `{ path: string }` | æ–‡ä»¶åˆ›å»º |
| `file:updated` | `{ path: string }` | æ–‡ä»¶æ›´æ–° |
| `file:deleted` | `{ path: string }` | æ–‡ä»¶åˆ é™¤ |
| `search:started` | `{ query: string, scope: string }` | æœç´¢å¼€å§‹ |
| `search:completed` | `{ query: string, results: number, duration: number }` | æœç´¢å®Œæˆ |
| `render:started` | `{ path: string, format: string }` | æ¸²æŸ“å¼€å§‹ |
| `render:completed` | `{ path: string, duration: number }` | æ¸²æŸ“å®Œæˆ |
| `export:started` | `{ paths: string[], format: string }` | å¯¼å‡ºå¼€å§‹ |
| `export:completed` | `{ format: string, duration: number }` | å¯¼å‡ºå®Œæˆ |

#### äº‹ä»¶è®¢é˜…ç¤ºä¾‹

```typescript
async initialize(context: PluginContext): Promise<void> {
  this.context = context;

  // è®¢é˜…æ–‡ä»¶å˜åŒ–äº‹ä»¶
  const fileWatcher = context.events.on('file:changed', (data) => {
    this.handleFileChange(data);
  });

  // è®¢é˜…æœç´¢å®Œæˆäº‹ä»¶ï¼ˆä¸€æ¬¡æ€§ï¼‰
  const searchWatcher = context.events.once('search:completed', (data) => {
    this.handleSearchComplete(data);
  });

  // è®¢é˜…æ‰€æœ‰äº‹ä»¶
  context.events.onAny((event, data) => {
    context.logger.debug(`Event received: ${event}`, data);
  });

  // å–æ¶ˆè®¢é˜…
  fileWatcher.dispose();
  searchWatcher.dispose();
}
```

#### å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶

```typescript
async activate(): Promise<void> {
  // å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶
  this.context?.events.emit('my-plugin:ready', {
    version: this.version,
    capabilities: ['renderer', 'transformer']
  });

  // å¸¦å¤æ‚æ•°æ®çš„è‡ªå®šä¹‰äº‹ä»¶
  this.context?.events.emit('my-plugin:progress', {
    current: 50,
    total: 100,
    message: 'Processing...'
  });
}
```

### å‚æ•°å’Œè¿”å›å€¼è¯´æ˜

#### initialize æ–¹æ³•

```typescript
initialize(context: PluginContext): Promise<void>
```

**å‚æ•°**:
- `context`: æ’ä»¶ä¸Šä¸‹æ–‡å¯¹è±¡

**è¿”å›å€¼**:
- `Promise<void>`: åˆå§‹åŒ–å®Œæˆå resolve

**ä½¿ç”¨åœºæ™¯**:
- åˆå§‹åŒ–æ’ä»¶èµ„æº
- æ³¨å†Œæ¸²æŸ“å™¨ã€è½¬æ¢å™¨ç­‰
- è®¢é˜…äº‹ä»¶
- åŠ è½½é…ç½®

#### activate æ–¹æ³•

```typescript
activate(): Promise<void>
```

**å‚æ•°**:
- æ— 

**è¿”å›å€¼**:
- `Promise<void>`: æ¿€æ´»å®Œæˆå resolve

**ä½¿ç”¨åœºæ™¯**:
- å¯åŠ¨æ’ä»¶åŠŸèƒ½
- å¼€å§‹æ‰§è¡Œä»»åŠ¡
- å¯åŠ¨å®šæ—¶å™¨æˆ–è½®è¯¢

#### deactivate æ–¹æ³•

```typescript
deactivate(): Promise<void>
```

**å‚æ•°**:
- æ— 

**è¿”å›å€¼**:
- `Promise<void>`: åœç”¨å®Œæˆå resolve

**ä½¿ç”¨åœºæ™¯**:
- æš‚åœæ’ä»¶åŠŸèƒ½
- ä¿å­˜å½“å‰çŠ¶æ€
- åœæ­¢å®šæ—¶å™¨

#### dispose æ–¹æ³•

```typescript
dispose(): Promise<void>
```

**å‚æ•°**:
- æ— 

**è¿”å›å€¼**:
- `Promise<void>`: æ¸…ç†å®Œæˆå resolve

**ä½¿ç”¨åœºæ™¯**:
- æ¸…ç†æ‰€æœ‰èµ„æº
- å–æ¶ˆæ‰€æœ‰äº‹ä»¶è®¢é˜…
- é‡Šæ”¾å†…å­˜å’Œæ–‡ä»¶å¥æŸ„

---

## å¸¸è§æ’ä»¶æ¨¡å¼

### æ•°æ®å¤„ç†æ’ä»¶æ¨¡å¼

æ•°æ®å¤„ç†æ’ä»¶ç”¨äºå¤„ç†å’Œè½¬æ¢å†…å®¹æ•°æ®ã€‚

#### æ¨¡å¼ç‰¹ç‚¹

- æ¥æ”¶åŸå§‹æ•°æ®è¾“å…¥
- æ‰§è¡Œè½¬æ¢æˆ–å¤„ç†é€»è¾‘
- è¿”å›å¤„ç†åçš„æ•°æ®
- æ”¯æŒé“¾å¼å¤„ç†

#### å®Œæ•´ç¤ºä¾‹

```typescript
// src/DataProcessor.ts
import type { PluginContext } from '../../types/plugin.js';

/**
 * æ•°æ®å¤„ç†é€‰é¡¹
 */
export interface DataProcessorOptions {
  /** æ˜¯å¦å¯ç”¨ç¼“å­˜ */
  enableCache?: boolean;
  /** ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ */
  cacheTTL?: number;
  /** æ˜¯å¦å¯ç”¨å‹ç¼© */
  enableCompression?: boolean;
}

/**
 * å¤„ç†ç»“æœ
 */
export interface ProcessResult<T> {
  /** å¤„ç†åçš„æ•°æ® */
  data: T;
  /** æ˜¯å¦æ¥è‡ªç¼“å­˜ */
  cached: boolean;
  /** å¤„ç†è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰ */
  duration: number;
  /** å¤„ç†å¤§å°ï¼ˆå­—èŠ‚ï¼‰ */
  size: number;
}

/**
 * æ•°æ®å¤„ç†å™¨åŸºç±»
 */
export abstract class DataProcessor<TInput, TOutput> {
  protected context: PluginContext;
  protected cache: Map<string, { data: TOutput; timestamp: number }>;
  protected options: DataProcessorOptions;

  constructor(context: PluginContext, options?: DataProcessorOptions) {
    this.context = context;
    this.options = {
      enableCache: true,
      cacheTTL: 5 * 60 * 1000, // 5 åˆ†é’Ÿ
      enableCompression: false,
      ...options
    };
    this.cache = new Map();
  }

  /**
   * æŠ½è±¡æ–¹æ³•ï¼šå¤„ç†æ•°æ®
   */
  protected abstract process(input: TInput): Promise<TOutput>;

  /**
   * ç”Ÿæˆç¼“å­˜é”®
   */
  protected getCacheKey(input: TInput): string {
    return JSON.stringify(input);
  }

  /**
   * å¤„ç†æ•°æ®ï¼ˆå¸¦ç¼“å­˜ï¼‰
   */
  async handle(input: TInput): Promise<ProcessResult<TOutput>> {
    const startTime = Date.now();
    const cacheKey = this.getCacheKey(input);

    // æ£€æŸ¥ç¼“å­˜
    if (this.options.enableCache) {
      const cached = this.cache.get(cacheKey);
      if (cached && Date.now() - cached.timestamp < this.options.cacheTTL!) {
        const size = JSON.stringify(cached.data).length;
        return {
          data: cached.data,
          cached: true,
          duration: Date.now() - startTime,
          size
        };
      }
    }

    // å¤„ç†æ•°æ®
    const data = await this.process(input);

    // æ›´æ–°ç¼“å­˜
    if (this.options.enableCache) {
      this.cache.set(cacheKey, {
        data,
        timestamp: Date.now()
      });
    }

    const size = JSON.stringify(data).length;
    return {
      data,
      cached: false,
      duration: Date.now() - startTime,
      size
    };
  }

  /**
   * æ¸…ç†ç¼“å­˜
   */
  clearCache(): void {
    this.cache.clear();
  }

  /**
   * æ¸…ç†è¿‡æœŸç¼“å­˜
   */
  cleanExpiredCache(): void {
    const now = Date.now();
    for (const [key, value] of this.cache.entries()) {
      if (now - value.timestamp > this.options.cacheTTL!) {
        this.cache.delete(key);
      }
    }
  }

  /**
   * è·å–ç¼“å­˜ç»Ÿè®¡
   */
  getCacheStats(): {
    size: number;
    hitRate: number;
  } {
    return {
      size: this.cache.size,
      hitRate: 0 // éœ€è¦è·Ÿè¸ªå‘½ä¸­æ¬¡æ•°
    };
  }

  /**
   * é”€æ¯å¤„ç†å™¨
   */
  dispose(): void {
    this.clearCache();
  }
}

/**
 * Markdown æ•°æ®å¤„ç†å™¨ç¤ºä¾‹
 */
export class MarkdownProcessor extends DataProcessor<string, string> {
  constructor(context: PluginContext, options?: DataProcessorOptions) {
    super(context, options);
  }

  protected async process(markdown: string): Promise<string> {
    this.context.logger.debug('Processing markdown...');

    // ç¤ºä¾‹ï¼šç®€å•çš„ Markdown å¤„ç†
    let html = markdown
      // è½¬æ¢æ ‡é¢˜
      .replace(/^# (.*$)/gim, '<h1>$1</h1>')
      .replace(/^## (.*$)/gim, '<h2>$1</h2>')
      .replace(/^### (.*$)/gim, '<h3>$1</h3>')
      // è½¬æ¢ç²—ä½“
      .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
      // è½¬æ¢æ–œä½“
      .replace(/\*(.*)\*/gim, '<em>$1</em>')
      // è½¬æ¢ä»£ç å—
      .replace(/```(\w+)?\n([\s\S]*?)\n```/gim, '<pre><code class="language-$1">$2</code></pre>')
      // è½¬æ¢è¡Œå†…ä»£ç 
      .replace(/`([^`]+)`/gim, '<code>$1</code>')
      // è½¬æ¢é“¾æ¥
      .replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2">$1</a>');

    this.context.logger.info('Markdown processed successfully');
    return html;
  }
}
```

#### ä½¿ç”¨ç¤ºä¾‹

```typescript
// src/index.ts
import type { Plugin, PluginContext, PluginManifest } from '../../types/plugin.js';
import { MarkdownProcessor } from './DataProcessor.js';

export class DataProcessingPlugin implements Plugin {
  readonly id = 'data-processor';
  readonly name = 'Data Processing Plugin';
  readonly version = '1.0.0';
  readonly manifest: PluginManifest;
  private context?: PluginContext;
  private processor?: MarkdownProcessor;

  constructor(manifest: PluginManifest) {
    this.manifest = manifest;
  }

  async initialize(context: PluginContext): Promise<void> {
    this.context = context;
    this.processor = new MarkdownProcessor(context, {
      enableCache: true,
      cacheTTL: 10 * 60 * 1000
    });

    context.logger.info('Data Processing Plugin initialized');
  }

  async activate(): Promise<void> {
    // ç¤ºä¾‹ï¼šå¤„ç† Markdown
    const markdown = `# Hello World

This is a **test** paragraph with *italic* text.

\`\`\`javascript
console.log('Hello');
\`\`\`
`;

    const result = await this.processor?.handle(markdown);
    this.context?.logger.info('Processing result:', result);
  }

  async deactivate(): Promise<void> {
    this.processor?.dispose();
  }

  async dispose(): Promise<void> {
    this.processor?.dispose();
  }
}

export default DataProcessingPlugin;
```

### UI æ‰©å±•æ’ä»¶æ¨¡å¼

UI æ‰©å±•æ’ä»¶ç”¨äºæ·»åŠ è‡ªå®šä¹‰ UI ç»„ä»¶å’Œç•Œé¢å…ƒç´ ã€‚

#### æ¨¡å¼ç‰¹ç‚¹

- è´¡çŒ® UI ç»„ä»¶
- è‡ªå®šä¹‰é¢æ¿å’Œå·¥å…·æ 
- æ·»åŠ èœå•é¡¹å’Œå‘½ä»¤
- é›†æˆåˆ°ç°æœ‰ç•Œé¢

#### å®Œæ•´ç¤ºä¾‹

```typescript
// src/UIExtension.ts
import type { PluginContext } from '../../types/plugin.js';

/**
 * UI ç»„ä»¶é…ç½®
 */
export interface UIComponentConfig {
  /** ç»„ä»¶ ID */
  id: string;
  /** ç»„ä»¶ç±»å‹ */
  type: 'panel' | 'modal' | 'toolbar' | 'menu';
  /** ç»„ä»¶æ ‡é¢˜ */
  title: string;
  /** æ˜¾ç¤ºä½ç½® */
  position?: 'left' | 'right' | 'top' | 'bottom' | 'center';
  /** ä¼˜å…ˆçº§ */
  priority?: number;
  /** å›¾æ ‡ */
  icon?: string;
  /** å¿«æ·é”® */
  keybinding?: string;
}

/**
 * UI æ‰©å±•åŸºç±»
 */
export abstract class UIExtension {
  protected context: PluginContext;
  protected components: Map<string, UIComponentConfig>;

  constructor(context: PluginContext) {
    this.context = context;
    this.components = new Map();
  }

  /**
   * æŠ½è±¡æ–¹æ³•ï¼šæ¸²æŸ“ç»„ä»¶
   */
  protected abstract renderComponent(config: UIComponentConfig): string;

  /**
   * æ³¨å†Œç»„ä»¶
   */
  registerComponent(config: UIComponentConfig): void {
    this.components.set(config.id, config);
    this.context.logger.info(`UI component registered: ${config.id}`);

    // å‘å¸ƒç»„ä»¶æ³¨å†Œäº‹ä»¶
    this.context.events.emit('ui:component:registered', config);
  }

  /**
   * æ³¨é”€ç»„ä»¶
   */
  unregisterComponent(id: string): void {
    this.components.delete(id);
    this.context.logger.info(`UI component unregistered: ${id}`);

    // å‘å¸ƒç»„ä»¶æ³¨é”€äº‹ä»¶
    this.context.events.emit('ui:component:unregistered', { id });
  }

  /**
   * è·å–ç»„ä»¶é…ç½®
   */
  getComponent(id: string): UIComponentConfig | undefined {
    return this.components.get(id);
  }

  /**
   * è·å–æ‰€æœ‰ç»„ä»¶
   */
  getAllComponents(): UIComponentConfig[] {
    return Array.from(this.components.values());
  }

  /**
   * æ¸²æŸ“ç»„ä»¶
   */
  render(id: string): string | undefined {
    const config = this.getComponent(id);
    if (!config) {
      this.context.logger.warn(`Component not found: ${id}`);
      return undefined;
    }

    return this.renderComponent(config);
  }

  /**
   * é”€æ¯æ‰©å±•
   */
  dispose(): void {
    this.components.clear();
  }
}

/**
 * è‡ªå®šä¹‰é¢æ¿æ‰©å±•ç¤ºä¾‹
 */
export class CustomPanelExtension extends UIExtension {
  protected renderComponent(config: UIComponentConfig): string {
    if (config.type !== 'panel') {
      throw new Error('This extension only supports panel components');
    }

    return `
      <div class="custom-panel" id="${config.id}">
        <div class="panel-header">
          <h3>${config.title}</h3>
          ${config.icon ? `<span class="icon">${config.icon}</span>` : ''}
        </div>
        <div class="panel-content">
          ${this.renderPanelContent(config.id)}
        </div>
      </div>
    `;
  }

  private renderPanelContent(id: string): string {
    // æ ¹æ®é¢æ¿ ID æ¸²æŸ“ä¸åŒçš„å†…å®¹
    switch (id) {
      case 'info-panel':
        return `
          <div class="info-content">
            <p>Fold-Site version: ${this.context.app.version}</p>
            <p>Environment: ${this.context.app.environment}</p>
            <p>Plugins loaded: ${this.getPluginCount()}</p>
          </div>
        `;
      case 'stats-panel':
        return `
          <div class="stats-content">
            <div class="stat-item">
              <span class="stat-label">Files</span>
              <span class="stat-value">0</span>
            </div>
          </div>
        `;
      default:
        return '<p>No content available</p>';
    }
  }

  private getPluginCount(): number {
    // æ¨¡æ‹Ÿè·å–æ’ä»¶æ•°é‡
    return 1;
  }
}
```

#### ä½¿ç”¨ç¤ºä¾‹

```typescript
// src/index.ts
import type { Plugin, PluginContext, PluginManifest } from '../../types/plugin.js';
import { CustomPanelExtension } from './UIExtension.js';

export class UIExtensionPlugin implements Plugin {
  readonly id = 'ui-extension';
  readonly name = 'UI Extension Plugin';
  readonly version = '1.0.0';
  readonly manifest: PluginManifest;
  private context?: PluginContext;
  private extension?: CustomPanelExtension;

  constructor(manifest: PluginManifest) {
    this.manifest = manifest;
  }

  async initialize(context: PluginContext): Promise<void> {
    this.context = context;
    this.extension = new CustomPanelExtension(context);

    // æ³¨å†Œä¿¡æ¯é¢æ¿
    this.extension.registerComponent({
      id: 'info-panel',
      type: 'panel',
      title: 'Information',
      position: 'right',
      priority: 100,
      icon: 'â„¹ï¸'
    });

    // æ³¨å†Œç»Ÿè®¡é¢æ¿
    this.extension.registerComponent({
      id: 'stats-panel',
      type: 'panel',
      title: 'Statistics',
      position: 'right',
      priority: 90,
      icon: 'ğŸ“Š'
    });

    context.logger.info('UI Extension Plugin initialized');
  }

  async activate(): Promise<void> {
    // æ¸²æŸ“é¢æ¿
    const infoPanel = this.extension?.render('info-panel');
    const statsPanel = this.extension?.render('stats-panel');

    this.context?.logger.info('Panels rendered');
  }

  async deactivate(): Promise<void> {
    this.extension?.dispose();
  }

  async dispose(): Promise<void> {
    this.extension?.dispose();
  }
}

export default UIExtensionPlugin;
```

### äº‹ä»¶ç›‘å¬æ’ä»¶æ¨¡å¼

äº‹ä»¶ç›‘å¬æ’ä»¶é€šè¿‡ç›‘å¬ç³»ç»Ÿäº‹ä»¶æ¥æ‰©å±•åŠŸèƒ½ã€‚

#### æ¨¡å¼ç‰¹ç‚¹

- ç›‘å¬ç³»ç»Ÿäº‹ä»¶
- å“åº”äº‹ä»¶è§¦å‘æ“ä½œ
- æ”¯æŒäº‹ä»¶è¿‡æ»¤å’Œè½¬æ¢
- å¯å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶

#### å®Œæ•´ç¤ºä¾‹

```typescript
// src/EventListener.ts
import type { PluginContext, Disposable } from '../../types/plugin.js';

/**
 * äº‹ä»¶å¤„ç†å™¨ç±»å‹
 */
export type EventHandler<T = unknown> = (data: T) => void | Promise<void>;

/**
 * äº‹ä»¶ç›‘å¬å™¨é…ç½®
 */
export interface EventListenerConfig {
  /** äº‹ä»¶åç§° */
  event: string;
  /** å¤„ç†å™¨ */
  handler: EventHandler;
  /** æ˜¯å¦åªæ‰§è¡Œä¸€æ¬¡ */
  once?: boolean;
  /** ä¼˜å…ˆçº§ */
  priority?: number;
}

/**
 * äº‹ä»¶ç›‘å¬å™¨ç®¡ç†å™¨
 */
export class EventListenerManager {
  private context: PluginContext;
  private listeners: Map<string, Disposable[]>;
  private filter?: (event: string, data: unknown) => boolean;

  constructor(context: PluginContext) {
    this.context = context;
    this.listeners = new Map();
  }

  /**
   * è®¾ç½®äº‹ä»¶è¿‡æ»¤å™¨
   */
  setFilter(filter: (event: string, data: unknown) => boolean): void {
    this.filter = filter;
  }

  /**
   * ç›‘å¬äº‹ä»¶
   */
  on<T = unknown>(event: string, handler: EventHandler<T>): void {
    const wrappedHandler = (data: T) => {
      // åº”ç”¨è¿‡æ»¤å™¨
      if (this.filter && !this.filter(event, data)) {
        return;
      }

      // æ‰§è¡Œå¤„ç†å™¨
      try {
        const result = handler(data);
        if (result instanceof Promise) {
          result.catch(error => {
            this.context.logger.error(`Event handler error for ${event}:`, error);
          });
        }
      } catch (error) {
        this.context.logger.error(`Event handler error for ${event}:`, error);
      }
    };

    const disposable = this.context.events.on(event, wrappedHandler);

    if (!this.listeners.has(event)) {
      this.listeners.set(event, []);
    }
    this.listeners.get(event)!.push(disposable);

    this.context.logger.debug(`Event listener registered: ${event}`);
  }

  /**
   * ç›‘å¬äº‹ä»¶ï¼ˆä¸€æ¬¡æ€§ï¼‰
   */
  once<T = unknown>(event: string, handler: EventHandler<T>): void {
    const disposable = this.context.events.once(event, (data: T) => {
      // ç§»é™¤ç›‘å¬å™¨
      const listeners = this.listeners.get(event);
      if (listeners) {
        const index = listeners.indexOf(disposable);
        if (index > -1) {
          listeners.splice(index, 1);
        }
      }

      // æ‰§è¡Œå¤„ç†å™¨
      handler(data);
    });

    if (!this.listeners.has(event)) {
      this.listeners.set(event, []);
    }
    this.listeners.get(event)!.push(disposable);

    this.context.logger.debug(`One-time event listener registered: ${event}`);
  }

  /**
   * å–æ¶ˆæ‰€æœ‰äº‹ä»¶ç›‘å¬
   */
  off(event?: string): void {
    if (event) {
      // å–æ¶ˆæŒ‡å®šäº‹ä»¶çš„æ‰€æœ‰ç›‘å¬å™¨
      const listeners = this.listeners.get(event);
      if (listeners) {
        listeners.forEach(disposable => disposable.dispose());
        this.listeners.delete(event);
        this.context.logger.debug(`All listeners removed for event: ${event}`);
      }
    } else {
      // å–æ¶ˆæ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
      for (const [evt, disposables] of this.listeners.entries()) {
        disposables.forEach(disposable => disposable.dispose());
      }
      this.listeners.clear();
      this.context.logger.debug('All event listeners removed');
    }
  }

  /**
   * è·å–ç›‘å¬å™¨æ•°é‡
   */
  getListenerCount(event?: string): number {
    if (event) {
      return this.listeners.get(event)?.length || 0;
    }
    return Array.from(this.listeners.values()).reduce((sum, arr) => sum + arr.length, 0);
  }

  /**
   * é”€æ¯ç®¡ç†å™¨
   */
  dispose(): void {
    this.off();
  }
}

/**
 * æ–‡ä»¶ç›‘å¬å™¨ç¤ºä¾‹
 */
export class FileWatcher {
  private manager: EventListenerManager;
  private fileChanges: Map<string, number>;

  constructor(context: PluginContext) {
    this.manager = new EventListenerManager(context);
    this.fileChanges = new Map();
  }

  /**
   * å¯åŠ¨æ–‡ä»¶ç›‘å¬
   */
  start(): void {
    // ç›‘å¬æ–‡ä»¶å˜åŒ–
    this.manager.on<{ path: string; type: string }>('file:changed', (data) => {
      this.handleFileChange(data);
    });

    // ç›‘å¬æ–‡ä»¶åˆ›å»º
    this.manager.on<{ path: string }>('file:created', (data) => {
      this.context.logger.info('File created:', data.path);
    });

    // ç›‘å¬æ–‡ä»¶åˆ é™¤
    this.manager.on<{ path: string }>('file:deleted', (data) => {
      this.context.logger.info('File deleted:', data.path);
      this.fileChanges.delete(data.path);
    });
  }

  private handleFileChange(data: { path: string; type: string }): void {
    const now = Date.now();
    this.fileChanges.set(data.path, now);

    this.context.logger.info(`File ${data.type}:`, data.path);

    // æ£€æŸ¥æ˜¯å¦é¢‘ç¹å˜åŒ–
    const lastChange = this.fileChanges.get(data.path) || 0;
    if (now - lastChange < 1000) {
      this.context.logger.warn('File changing frequently:', data.path);
    }
  }

  /**
   * åœæ­¢æ–‡ä»¶ç›‘å¬
   */
  stop(): void {
    this.manager.dispose();
  }

  /**
   * è·å–æ–‡ä»¶å˜åŒ–ç»Ÿè®¡
   */
  getStats(): {
    totalChanges: number;
    filesChanged: number;
  } {
    return {
      totalChanges: Array.from(this.fileChanges.values()).length,
      filesChanged: this.fileChanges.size
    };
  }

  private get context(): PluginContext {
    return (this.manager as any).context;
  }
}
```

#### ä½¿ç”¨ç¤ºä¾‹

```typescript
// src/index.ts
import type { Plugin, PluginContext, PluginManifest } from '../../types/plugin.js';
import { FileWatcher } from './EventListener.js';

export class EventListenerPlugin implements Plugin {
  readonly id = 'event-listener';
  readonly name = 'Event Listener Plugin';
  readonly version = '1.0.0';
  readonly manifest: PluginManifest;
  private context?: PluginContext;
  private fileWatcher?: FileWatcher;

  constructor(manifest: PluginManifest) {
    this.manifest = manifest;
  }

  async initialize(context: PluginContext): Promise<void> {
    this.context = context;
    this.fileWatcher = new FileWatcher(context);

    context.logger.info('Event Listener Plugin initialized');
  }

  async activate(): Promise<void> {
    // å¯åŠ¨æ–‡ä»¶ç›‘å¬
    this.fileWatcher?.start();

    this.context?.logger.info('Event Listener Plugin activated');
  }

  async deactivate(): Promise<void> {
    // åœæ­¢æ–‡ä»¶ç›‘å¬
    this.fileWatcher?.stop();

    this.context?.logger.info('Event Listener Plugin deactivated');
  }

  async dispose(): Promise<void> {
    this.fileWatcher?.stop();
  }
}

export default EventListenerPlugin;
```

### ä¸­é—´ä»¶æ’ä»¶æ¨¡å¼

ä¸­é—´ä»¶æ’ä»¶ç”¨äºæ‹¦æˆªå’Œå¤„ç†è¯·æ±‚/å“åº”ã€‚

#### æ¨¡å¼ç‰¹ç‚¹

- æ‹¦æˆªè¯·æ±‚å’Œå“åº”
- ä¿®æ”¹æ•°æ®
- æ·»åŠ éªŒè¯å’Œæˆæƒ
- æ”¯æŒé“¾å¼å¤„ç†

#### å®Œæ•´ç¤ºä¾‹

```typescript
// src/Middleware.ts
import type { PluginContext } from '../../types/plugin.js';

/**
 * ä¸­é—´ä»¶ä¸Šä¸‹æ–‡
 */
export interface MiddlewareContext<T = unknown> {
  /** è¯·æ±‚æ•°æ® */
  request: T;
  /** å“åº”æ•°æ® */
  response?: unknown;
  /** å…ƒæ•°æ® */
  metadata: Record<string, unknown>;
  /** æ˜¯å¦å·²ç»ˆæ­¢ */
  terminated: boolean;
}

/**
 * ä¸­é—´ä»¶å¤„ç†å™¨
 */
export type MiddlewareHandler<T = unknown> = (
  ctx: MiddlewareContext<T>,
  next: () => Promise<void>
) => Promise<void>;

/**
 * ä¸­é—´ä»¶æ’ä»¶
 */
export class MiddlewarePlugin<T = unknown> {
  private context: PluginContext;
  private middlewares: MiddlewareHandler<T>[];

  constructor(context: PluginContext) {
    this.context = context;
    this.middlewares = [];
  }

  /**
   * æ·»åŠ ä¸­é—´ä»¶
   */
  use(handler: MiddlewareHandler<T>): void {
    this.middlewares.push(handler);
    this.context.logger.debug('Middleware added');
  }

  /**
   * æ‰§è¡Œä¸­é—´ä»¶é“¾
   */
  async execute(request: T): Promise<MiddlewareContext<T>> {
    const ctx: MiddlewareContext<T> = {
      request,
      metadata: {},
      terminated: false
    };

    let index = 0;

    const next = async (): Promise<void> => {
      if (ctx.terminated || index >= this.middlewares.length) {
        return;
      }

      const handler = this.middlewares[index++];
      await handler(ctx, next);
    };

    try {
      await next();
    } catch (error) {
      this.context.logger.error('Middleware execution error:', error);
      ctx.metadata.error = error;
    }

    return ctx;
  }

  /**
   * æ¸…é™¤æ‰€æœ‰ä¸­é—´ä»¶
   */
  clear(): void {
    this.middlewares = [];
  }

  /**
   * è·å–ä¸­é—´ä»¶æ•°é‡
   */
  get size(): number {
    return this.middlewares.length;
  }
}

/**
 * æ—¥å¿—ä¸­é—´ä»¶
 */
export function createLoggingMiddleware<T>(context: PluginContext): MiddlewareHandler<T> {
  return async (ctx, next) => {
    const startTime = Date.now();

    context.logger.debug('Request started:', ctx.request);

    await next();

    const duration = Date.now() - startTime;
    context.logger.debug(`Request completed in ${duration}ms`);
  };
}

/**
 * éªŒè¯ä¸­é—´ä»¶
 */
export function createValidationMiddleware<T>(
  validator: (data: T) => boolean,
  context: PluginContext
): MiddlewareHandler<T> {
  return async (ctx, next) => {
    if (!validator(ctx.request)) {
      ctx.terminated = true;
      ctx.metadata.error = 'Validation failed';
      context.logger.warn('Request validation failed');
      return;
    }

    await next();
  };
}

/**
 * è½¬æ¢ä¸­é—´ä»¶
 */
export function createTransformMiddleware<TIn, TOut>(
  transformer: (data: TIn) => TOut,
  context: PluginContext
): MiddlewareHandler<TIn> {
  return async (ctx, next) => {
    const transformed = transformer(ctx.request);
    ctx.metadata.transformed = transformed;

    await next();
  };
}
```

#### ä½¿ç”¨ç¤ºä¾‹

```typescript
// src/index.ts
import type { Plugin, PluginContext, PluginManifest } from '../../types/plugin.js';
import {
  MiddlewarePlugin,
  createLoggingMiddleware,
  createValidationMiddleware,
  createTransformMiddleware
} from './Middleware.js';

interface RenderRequest {
  content: string;
  format: string;
  options?: Record<string, unknown>;
}

export class MiddlewarePluginExample implements Plugin {
  readonly id = 'middleware-plugin';
  readonly name = 'Middleware Plugin';
  readonly version = '1.0.0';
  readonly manifest: PluginManifest;
  private context?: PluginContext;
  private middleware?: MiddlewarePlugin<RenderRequest>;

  constructor(manifest: PluginManifest) {
    this.manifest = manifest;
  }

  async initialize(context: PluginContext): Promise<void> {
    this.context = context;
    this.middleware = new MiddlewarePlugin<RenderRequest>(context);

    // æ·»åŠ æ—¥å¿—ä¸­é—´ä»¶
    this.middleware.use(createLoggingMiddleware(context));

    // æ·»åŠ éªŒè¯ä¸­é—´ä»¶
    this.middleware.use(createValidationMiddleware(
      (req) => !!req.content && !!req.format,
      context
    ));

    // æ·»åŠ è½¬æ¢ä¸­é—´ä»¶
    this.middleware.use(createTransformMiddleware(
      (req) => ({
        ...req,
        content: req.content.trim(),
        format: req.format.toLowerCase()
      }),
      context
    ));

    context.logger.info('Middleware Plugin initialized');
  }

  async activate(): Promise<void> {
    // æ‰§è¡Œä¸­é—´ä»¶é“¾
    const result = await this.middleware?.execute({
      content: '  Hello World  ',
      format: 'HTML',
      options: { highlight: true }
    });

    this.context?.logger.info('Middleware result:', result);
  }

  async deactivate(): Promise<void> {
    this.middleware?.clear();
  }

  async dispose(): Promise<void> {
    this.middleware?.clear();
  }
}

export default MiddlewarePluginExample;
```

---

## è¿›é˜¶ä¸»é¢˜

### æ’ä»¶é—´é€šä¿¡

æ’ä»¶ä¹‹é—´å¯ä»¥é€šè¿‡äº‹ä»¶ç³»ç»Ÿè¿›è¡Œé€šä¿¡ã€‚

#### é€šä¿¡æ¨¡å¼

```mermaid
sequenceDiagram
    participant P1 as Plugin A
    participant E as Event System
    participant P2 as Plugin B
    participant P3 as Plugin C

    P1->>E: emit('custom:event', data)
    E->>P2: trigger handler
    E->>P3: trigger handler
    P2-->>E: response
    P3-->>E: response
```

#### å‘å¸ƒ-è®¢é˜…æ¨¡å¼

```typescript
// æ’ä»¶ Aï¼šå‘å¸ƒäº‹ä»¶
class PublisherPlugin implements Plugin {
  async activate(): Promise<void> {
    // å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶
    this.context?.events.emit('my-plugin:data-updated', {
      source: 'publisher',
      timestamp: Date.now(),
      data: { message: 'Hello from Publisher' }
    });
  }
}

// æ’ä»¶ Bï¼šè®¢é˜…äº‹ä»¶
class SubscriberPlugin implements Plugin {
  private disposables: Disposable[] = [];

  async initialize(context: PluginContext): Promise<void> {
    // è®¢é˜…äº‹ä»¶
    const disposable = context.events.on('my-plugin:data-updated', (data) => {
      context.logger.info('Data updated:', data);
      this.handleDataUpdate(data);
    });
    this.disposables.push(disposable);
  }

  async deactivate(): Promise<void> {
    // å–æ¶ˆæ‰€æœ‰è®¢é˜…
    this.disposables.forEach(d => d.dispose());
    this.disposables = [];
  }

  private handleDataUpdate(data: any): void {
    // å¤„ç†æ•°æ®æ›´æ–°
  }
}
```

#### è¯·æ±‚-å“åº”æ¨¡å¼

```typescript
// æ’ä»¶ Aï¼šå‘é€è¯·æ±‚
class RequesterPlugin implements Plugin {
  async activate(): Promise<void> {
    // å‘é€è¯·æ±‚å¹¶ç­‰å¾…å“åº”
    const requestId = `request-${Date.now()}`;

    // è®¢é˜…å“åº”
    const responseDisposable = this.context?.events.on(
      `response:${requestId}`,
      (data) => {
        this.context?.logger.info('Response received:', data);
        responseDisposable?.dispose();
      }
    );

    // å‘é€è¯·æ±‚
    this.context?.events.emit('my-plugin:request', {
      requestId,
      action: 'get-data',
      params: { id: 123 }
    });
  }
}

// æ’ä»¶ Bï¼šå¤„ç†è¯·æ±‚
class ResponderPlugin implements Plugin {
  async initialize(context: PluginContext): Promise<void> {
    // ç›‘å¬è¯·æ±‚
    context.events.on('my-plugin:request', async (data: any) => {
      // å¤„ç†è¯·æ±‚
      const result = await this.handleRequest(data);

      // å‘é€å“åº”
      context.events.emit(`response:${data.requestId}`, {
        success: true,
        data: result
      });
    });
  }

  private async handleRequest(data: any): Promise<any> {
    // å¤„ç†ä¸šåŠ¡é€»è¾‘
    return { message: 'Response data' };
  }
}
```

### ä¾èµ–ç®¡ç†

æ’ä»¶å¯ä»¥å£°æ˜ä¾èµ–å…³ç³»ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è§£æå’ŒåŠ è½½ä¾èµ–ã€‚

#### å£°æ˜ä¾èµ–

```json
{
  "id": "plugin-a",
  "dependencies": {
    "plugin-b": ">=1.0.0",
    "plugin-c": "^2.0.0"
  },
  "peerDependencies": {
    "folder-site": ">=1.0.0"
  }
}
```

#### æ£€æŸ¥ä¾èµ–

```typescript
async initialize(context: PluginContext): Promise<void> {
  // æ£€æŸ¥ä¾èµ–æ’ä»¶æ˜¯å¦å·²åŠ è½½
  const pluginB = context.services.pluginRegistry?.get('plugin-b');

  if (!pluginB) {
    throw new Error('Required plugin "plugin-b" not found');
  }

  // è®¿é—®ä¾èµ–æ’ä»¶çš„åŠŸèƒ½
  const renderer = context.services.renderService?.getRenderer('plugin-b-renderer');
}
```

#### ä¾èµ–æ³¨å…¥

```typescript
class PluginA implements Plugin {
  private pluginB?: Plugin;
  private pluginC?: Plugin;

  async initialize(context: PluginContext): Promise<void> {
    // æ³¨å…¥ä¾èµ–æ’ä»¶
    this.pluginB = context.services.pluginRegistry?.get('plugin-b');
    this.pluginC = context.services.pluginRegistry?.get('plugin-c');

    // éªŒè¯ä¾èµ–
    if (!this.pluginB || !this.pluginC) {
      throw new Error('Required dependencies not available');
    }

    // ä½¿ç”¨ä¾èµ–æ’ä»¶
    this.usePluginB();
  }

  private usePluginB(): void {
    // è°ƒç”¨æ’ä»¶ B çš„åŠŸèƒ½
    if (this.pluginB && 'getData' in this.pluginB) {
      // @ts-ignore
      const data = this.pluginB.getData();
    }
  }
}
```

### æ’ä»¶é…ç½®å’Œé€‰é¡¹

æ’ä»¶å¯ä»¥å®šä¹‰é…ç½®é€‰é¡¹ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶è¿›è¡Œè‡ªå®šä¹‰ã€‚

#### å®šä¹‰é…ç½®æ¨¡å¼

```json
{
  "options": {
    "type": "object",
    "properties": {
      "apiKey": {
        "type": "string",
        "description": "API key for external service"
      },
      "timeout": {
        "type": "number",
        "description": "Request timeout in milliseconds",
        "default": 5000,
        "minimum": 1000,
        "maximum": 30000
      },
      "enableCache": {
        "type": "boolean",
        "description": "Enable response caching",
        "default": true
      },
      "theme": {
        "type": "string",
        "description": "UI theme",
        "enum": ["light", "dark", "auto"],
        "default": "auto"
      }
    },
    "required": ["apiKey"]
  }
}
```

#### ä½¿ç”¨é…ç½®

```typescript
async initialize(context: PluginContext): Promise<void> {
  // è·å–é…ç½®å€¼
  const apiKey = context.config.get('apiKey');
  const timeout = context.config.get('timeout', 5000);
  const enableCache = context.config.get('enableCache', true);
  const theme = context.config.get('theme', 'auto');

  // éªŒè¯å¿…éœ€é…ç½®
  if (!apiKey) {
    throw new Error('API key is required. Please configure it in your settings.');
  }

  // ä½¿ç”¨é…ç½®
  this.initializeWithConfig({
    apiKey,
    timeout,
    enableCache,
    theme
  });
}

async initializeWithConfig(config: {
  apiKey: string;
  timeout: number;
  enableCache: boolean;
  theme: string;
}): void {
  // ä½¿ç”¨é…ç½®åˆå§‹åŒ–
}
```

#### ç›‘å¬é…ç½®å˜åŒ–

```typescript
async initialize(context: PluginContext): Promise<void> {
  // ç›‘å¬é…ç½®å˜åŒ–
  const disposable = context.config.onChange('apiKey', (newValue) => {
    this.context?.logger.info('API key changed:', newValue);
    this.reinitializeWithApiKey(newValue);
  });

  // ä¿å­˜ disposable ä»¥ä¾¿æ¸…ç†
  this.configDisposables.push(disposable);
}

async deactivate(): Promise<void> {
  // æ¸…ç†é…ç½®ç›‘å¬å™¨
  this.configDisposables.forEach(d => d.dispose());
  this.configDisposables = [];
}
```

### æ€§èƒ½ä¼˜åŒ–æŠ€å·§

#### ä½¿ç”¨ç¼“å­˜

```typescript
class CachedRenderer {
  private cache: Map<string, { result: string; timestamp: number }>;
  private cacheTTL: number = 5 * 60 * 1000; // 5 åˆ†é’Ÿ

  async render(content: string): Promise<string> {
    const cacheKey = this.getCacheKey(content);

    // æ£€æŸ¥ç¼“å­˜
    const cached = this.cache.get(cacheKey);
    if (cached && Date.now() - cached.timestamp < this.cacheTTL) {
      return cached.result;
    }

    // æ¸²æŸ“å†…å®¹
    const result = await this.doRender(content);

    // æ›´æ–°ç¼“å­˜
    this.cache.set(cacheKey, {
      result,
      timestamp: Date.now()
    });

    return result;
  }

  private getCacheKey(content: string): string {
    // ç”Ÿæˆç¼“å­˜é”®ï¼ˆå¯ä»¥ä½¿ç”¨å“ˆå¸Œï¼‰
    return content;
  }

  private async doRender(content: string): Promise<string> {
    // å®é™…æ¸²æŸ“é€»è¾‘
    return content;
  }

  clearCache(): void {
    this.cache.clear();
  }
}
```

#### ä½¿ç”¨é˜²æŠ–å’ŒèŠ‚æµ

```typescript
class OptimizedProcessor {
  private debouncedUpdate: (path: string) => void;
  private throttledProcess: (data: any) => void;

  constructor(context: PluginContext) {
    // ä½¿ç”¨é˜²æŠ–ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼‰
    this.debouncedUpdate = context.utils.debounce((path: string) => {
      this.updateFile(path);
    }, 300);

    // ä½¿ç”¨èŠ‚æµï¼ˆé™åˆ¶æ‰§è¡Œé¢‘ç‡ï¼‰
    this.throttledProcess = context.utils.throttle((data: any) => {
      this.processData(data);
    }, 1000);
  }

  handleFileChange(path: string): void {
    // é˜²æŠ–ï¼šæ–‡ä»¶å˜åŒ–å 300ms æ‰§è¡Œä¸€æ¬¡
    this.debouncedUpdate(path);
  }

  handleDataUpdate(data: any): void {
    // èŠ‚æµï¼šæœ€å¤šæ¯ç§’æ‰§è¡Œä¸€æ¬¡
    this.throttledProcess(data);
  }

  private updateFile(path: string): void {
    // æ›´æ–°æ–‡ä»¶
  }

  private processData(data: any): void {
    // å¤„ç†æ•°æ®
  }
}
```

#### ä½¿ç”¨ Worker å¤„ç†å¯†é›†ä»»åŠ¡

```typescript
class WorkerProcessor {
  private worker?: Worker;

  async initialize(): Promise<void> {
    // åˆ›å»º Worker
    this.worker = new Worker('./worker.js', {
      type: 'module'
    });

    // ç›‘å¬ Worker æ¶ˆæ¯
    this.worker.on('message', (result) => {
      this.handleWorkerResult(result);
    });

    // ç›‘å¬ Worker é”™è¯¯
    this.worker.on('error', (error) => {
      this.context?.logger.error('Worker error:', error);
    });
  }

  async process(data: any): Promise<any> {
    return new Promise((resolve, reject) => {
      if (!this.worker) {
        reject(new Error('Worker not initialized'));
        return;
      }

      // å‘é€æ•°æ®åˆ° Worker
      this.worker.postMessage(data);

      // è®¾ç½®è¶…æ—¶
      const timeout = setTimeout(() => {
        reject(new Error('Worker timeout'));
      }, 30000);

      // ç›‘å¬å“åº”
      const handler = (result: any) => {
        clearTimeout(timeout);
        resolve(result);
      };

      this.worker.once('message', handler);
    });
  }

  private handleWorkerResult(result: any): void {
    // å¤„ç† Worker ç»“æœ
  }

  async dispose(): Promise<void> {
    this.worker?.terminate();
    this.worker = undefined;
  }
}
```

#### æ‰¹é‡å¤„ç†

```typescript
class BatchProcessor {
  private queue: any[] = [];
  private batchSize: number = 100;
  private flushInterval: number = 1000;
  private timer?: NodeJS.Timeout;

  async initialize(): Promise<void> {
    // å®šæœŸåˆ·æ–°é˜Ÿåˆ—
    this.timer = setInterval(() => {
      this.flush();
    }, this.flushInterval);
  }

  add(item: any): void {
    this.queue.push(item);

    // è¾¾åˆ°æ‰¹é‡å¤§å°ï¼Œç«‹å³åˆ·æ–°
    if (this.queue.length >= this.batchSize) {
      this.flush();
    }
  }

  private flush(): void {
    if (this.queue.length === 0) {
      return;
    }

    const batch = this.queue.splice(0, this.batchSize);
    this.processBatch(batch);
  }

  private async processBatch(batch: any[]): Promise<void> {
    // æ‰¹é‡å¤„ç†
    this.context?.logger.info(`Processing batch of ${batch.length} items`);

    // å¹¶è¡Œå¤„ç†
    const results = await Promise.all(
      batch.map(item => this.processItem(item))
    );

    // å¤„ç†ç»“æœ
    this.handleResults(results);
  }

  private async processItem(item: any): Promise<any> {
    // å¤„ç†å•ä¸ªé¡¹ç›®
    return item;
  }

  private handleResults(results: any[]): void {
    // å¤„ç†æ‰¹é‡ç»“æœ
  }

  async dispose(): Promise<void> {
    // åˆ·æ–°å‰©ä½™é¡¹ç›®
    this.flush();

    // æ¸…ç†å®šæ—¶å™¨
    if (this.timer) {
      clearInterval(this.timer);
      this.timer = undefined;
    }
  }
}
```

---

## è°ƒè¯•æŒ‡å—

### æœ¬åœ°å¼€å‘ç¯å¢ƒè®¾ç½®

#### é¡¹ç›®ç»“æ„

```
my-plugin/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts           # æ’ä»¶ä¸»å…¥å£
â”‚   â”œâ”€â”€ renderer.ts        # æ¸²æŸ“å™¨å®ç°
â”‚   â””â”€â”€ utils.ts           # å·¥å…·å‡½æ•°
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ plugin.test.ts     # æ’ä»¶æµ‹è¯•
â”œâ”€â”€ dist/                  # ç¼–è¯‘è¾“å‡º
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ manifest.json
â””â”€â”€ .folder-siterc.json    # æœ¬åœ°é…ç½®
```

#### é…ç½®æ–‡ä»¶

`.folder-siterc.json`

```json
{
  "plugins": ["./"],
  "logLevel": "debug",
  "watch": true,
  "hotReload": true
}
```

#### å¼€å‘è„šæœ¬

`package.json`

```json
{
  "scripts": {
    "build": "tsc",
    "dev": "tsc --watch",
    "test": "bun test",
    "lint": "eslint src --ext .ts",
    "typecheck": "tsc --noEmit",
    "clean": "rm -rf dist"
  }
}
```

### è°ƒè¯•å·¥å…·å’ŒæŠ€å·§

#### ä½¿ç”¨æ—¥å¿—

```typescript
async initialize(context: PluginContext): Promise<void> {
  // è°ƒè¯•æ—¥å¿—ï¼šè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
  context.logger.debug('Initializing plugin with config:', {
    id: this.id,
    version: this.version,
    manifest: this.manifest
  });

  // ä¿¡æ¯æ—¥å¿—ï¼šä¸€èˆ¬ä¿¡æ¯
  context.logger.info('Plugin initialized successfully');

  // è­¦å‘Šæ—¥å¿—ï¼šæ½œåœ¨é—®é¢˜
  context.logger.warn('API key not configured, using fallback');

  // é”™è¯¯æ—¥å¿—ï¼šé”™è¯¯ä¿¡æ¯
  context.logger.error('Failed to initialize plugin', error);
}
```

#### ä½¿ç”¨æ–­ç‚¹è°ƒè¯•

**æ–¹æ³• 1: ä½¿ç”¨ Node.js è°ƒè¯•å™¨**

```bash
# å¯åŠ¨è°ƒè¯•æ¨¡å¼
node --inspect-brk dist/index.js
```

ç„¶ååœ¨ Chrome æµè§ˆå™¨ä¸­æ‰“å¼€ `chrome://inspect` è¿›è¡Œè°ƒè¯•ã€‚

**æ–¹æ³• 2: ä½¿ç”¨ VS Code è°ƒè¯•**

åˆ›å»º `.vscode/launch.json`:

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "Debug Plugin",
      "runtimeExecutable": "bun",
      "runtimeArgs": ["--inspect-brk", "dist/index.js"],
      "skipFiles": ["<node_internals>/**"]
    }
  ]
}
```

ç„¶ååœ¨ä»£ç ä¸­è®¾ç½®æ–­ç‚¹å¹¶æŒ‰ F5 å¼€å§‹è°ƒè¯•ã€‚

#### ä½¿ç”¨æ€§èƒ½åˆ†æ

```typescript
async initialize(context: PluginContext): Promise<void> {
  const startTime = performance.now();

  // åˆå§‹åŒ–é€»è¾‘
  await this.doInitialize();

  const duration = performance.now() - startTime;
  context.logger.info(`Initialization took ${duration.toFixed(2)}ms`);

  // å¦‚æœåˆå§‹åŒ–æ—¶é—´è¿‡é•¿ï¼Œå‘å‡ºè­¦å‘Š
  if (duration > 1000) {
    context.logger.warn(`Slow initialization: ${duration.toFixed(2)}ms`);
  }
}
```

#### ä½¿ç”¨å†…å­˜åˆ†æ

```typescript
class MemoryAwarePlugin {
  private checkMemoryUsage(): void {
    const usage = process.memoryUsage();
    const usedMB = (usage.heapUsed / 1024 / 1024).toFixed(2);
    const totalMB = (usage.heapTotal / 1024 / 1024).toFixed(2);

    this.context?.logger.debug(`Memory usage: ${usedMB}MB / ${totalMB}MB`);

    // å†…å­˜ä½¿ç”¨è¿‡é«˜è­¦å‘Š
    if (usage.heapUsed > 100 * 1024 * 1024) {
      this.context?.logger.warn('High memory usage detected');
    }
  }

  async initialize(context: PluginContext): Promise<void> {
    this.context = context;

    // å®šæœŸæ£€æŸ¥å†…å­˜ä½¿ç”¨
    setInterval(() => {
      this.checkMemoryUsage();
    }, 30000);
  }
}
```

### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

#### é—®é¢˜ 1: æ’ä»¶æ— æ³•åŠ è½½

**ç—‡çŠ¶**: æ’ä»¶åŠ è½½å¤±è´¥ï¼Œæ§åˆ¶å°æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

**å¯èƒ½åŸå› **:
1. `manifest.json` æ ¼å¼é”™è¯¯
2. `entry` è·¯å¾„ä¸æ­£ç¡®
3. TypeScript ç¼–è¯‘é”™è¯¯
4. ä¾èµ–ç¼ºå¤±

**è§£å†³æ–¹æ¡ˆ**:

```bash
# 1. éªŒè¯ manifest.json æ ¼å¼
cat manifest.json | jq '.'

# 2. æ£€æŸ¥ç¼–è¯‘è¾“å‡º
ls -la dist/

# 3. è¿è¡Œ TypeScript æ£€æŸ¥
npm run typecheck

# 4. æ£€æŸ¥ä¾èµ–
npm list
```

#### é—®é¢˜ 2: ç±»å‹é”™è¯¯

**ç—‡çŠ¶**: TypeScript ç¼–è¯‘é”™è¯¯

**å¯èƒ½åŸå› **:
1. ç±»å‹å®šä¹‰ç¼ºå¤±
2. ç±»å‹ä¸åŒ¹é…
3. `tsconfig.json` é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:

```typescript
// ç¡®ä¿å¯¼å…¥æ­£ç¡®çš„ç±»å‹
import type { Plugin, PluginContext, PluginManifest } from '../../types/plugin.js';

// ä½¿ç”¨ç±»å‹æ–­è¨€ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
const renderer = context.services.renderService as any;

// ä½¿ç”¨ç±»å‹å®ˆå«
function isPlugin(obj: unknown): obj is Plugin {
  return typeof obj === 'object' &&
         obj !== null &&
         'id' in obj &&
         'name' in obj;
}
```

#### é—®é¢˜ 3: äº‹ä»¶æœªè§¦å‘

**ç—‡çŠ¶**: äº‹ä»¶ç›‘å¬å™¨æ²¡æœ‰æ”¶åˆ°äº‹ä»¶

**å¯èƒ½åŸå› **:
1. äº‹ä»¶åç§°æ‹¼å†™é”™è¯¯
2. ç›‘å¬å™¨æœªæ­£ç¡®æ³¨å†Œ
3. äº‹ä»¶å‘å¸ƒæ—¶æœºé—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:

```typescript
async initialize(context: PluginContext): Promise<void> {
  // 1. ç¡®è®¤äº‹ä»¶åç§°
  const eventName = 'file:changed';
  context.logger.debug(`Listening for event: ${eventName}`);

  // 2. ç¡®è®¤ç›‘å¬å™¨å·²æ³¨å†Œ
  const disposable = context.events.on(eventName, (data) => {
    context.logger.info('Event received:', data);
  });

  // 3. æµ‹è¯•äº‹ä»¶å‘å¸ƒ
  context.events.emit(eventName, { path: '/test', type: 'updated' });

  // 4. ç¡®è®¤ disposable ä¸ä¼šè¢«æå‰æ¸…ç†
  this.eventDisposables.push(disposable);
}
```

#### é—®é¢˜ 4: å†…å­˜æ³„æ¼

**ç—‡çŠ¶**: å†…å­˜å ç”¨æŒç»­å¢é•¿ï¼Œæœ€ç»ˆå¯¼è‡´å´©æºƒ

**å¯èƒ½åŸå› **:
1. æœªæ¸…ç†çš„äº‹ä»¶ç›‘å¬å™¨
2. æœªæ¸…ç†çš„å®šæ—¶å™¨
3. ç¼“å­˜æœªæ¸…ç†
4. å¾ªç¯å¼•ç”¨

**è§£å†³æ–¹æ¡ˆ**:

```typescript
async dispose(): Promise<void> {
  // 1. æ¸…ç†æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
  this.eventDisposables.forEach(d => d.dispose());
  this.eventDisposables = [];

  // 2. æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
  this.timers.forEach(timer => clearInterval(timer));
  this.timers = [];

  // 3. æ¸…ç†ç¼“å­˜
  this.cache.clear();

  // 4. æ¸…ç† Worker
  this.worker?.terminate();

  // 5. æ¸…ç†æ–‡ä»¶å¥æŸ„
  if (this.fileHandle) {
    await this.fileHandle.close();
  }

  this.context?.logger.info('All resources cleaned up');
}
```

### æ—¥å¿—è®°å½•å’Œé”™è¯¯å¤„ç†

#### ç»“æ„åŒ–æ—¥å¿—

```typescript
class StructuredLogger {
  constructor(private logger: PluginLogger) {}

  log(level: 'debug' | 'info' | 'warn' | 'error', message: string, meta?: any): void {
    const logEntry = {
      timestamp: new Date().toISOString(),
      level,
      message,
      plugin: this.pluginName,
      ...meta
    };

    this.logger[level](JSON.stringify(logEntry));
  }

  private get pluginName(): string {
    return 'my-plugin';
  }
}
```

#### é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

```typescript
async initialize(context: PluginContext): Promise<void> {
  try {
    // å°è¯•åˆå§‹åŒ–
    await this.doInitialize(context);
  } catch (error) {
    // è®°å½•é”™è¯¯
    context.logger.error('Initialization failed', {
      error: error instanceof Error ? error.message : String(error),
      stack: error instanceof Error ? error.stack : undefined,
      plugin: this.id
    });

    // åˆ›å»ºè‡ªå®šä¹‰é”™è¯¯
    const pluginError = new PluginError(
      'Failed to initialize plugin',
      this.id,
      this.version,
      'initialize',
      error instanceof Error ? error : undefined
    );

    // é‡æ–°æŠ›å‡ºé”™è¯¯
    throw pluginError;
  }
}

async doInitialize(context: PluginContext): Promise<void> {
  // åˆå§‹åŒ–é€»è¾‘
}
```

#### é‡è¯•æœºåˆ¶

```typescript
class RetryHandler {
  async execute<T>(
    fn: () => Promise<T>,
    options: {
      maxAttempts?: number;
      delay?: number;
      backoff?: boolean;
    } = {}
  ): Promise<T> {
    const {
      maxAttempts = 3,
      delay = 1000,
      backoff = true
    } = options;

    let lastError: Error | undefined;
    let currentDelay = delay;

    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
      try {
        return await fn();
      } catch (error) {
        lastError = error instanceof Error ? error : new Error(String(error));

        this.context?.logger.warn(
          `Attempt ${attempt}/${maxAttempts} failed: ${lastError.message}`
        );

        if (attempt < maxAttempts) {
          // ç­‰å¾…åé‡è¯•
          await this.wait(currentDelay);

          // æŒ‡æ•°é€€é¿
          if (backoff) {
            currentDelay *= 2;
          }
        }
      }
    }

    throw lastError;
  }

  private wait(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

---

## æµ‹è¯•æŒ‡å—

### å•å…ƒæµ‹è¯•æ’ä»¶

#### æµ‹è¯•æ¡†æ¶è®¾ç½®

ä½¿ç”¨ Bun å†…ç½®çš„æµ‹è¯•æ¡†æ¶ï¼š

```bash
# å®‰è£…æµ‹è¯•ä¾èµ–
npm install --save-dev bun-types

# åˆ›å»ºæµ‹è¯•ç›®å½•
mkdir tests
```

#### æµ‹è¯•æ’ä»¶ç±»

`tests/plugin.test.ts`

```typescript
import { describe, it, expect, beforeEach, afterEach, mock } from 'bun:test';
import MyPlugin from '../src/index';
import type { PluginManifest, PluginContext } from '../../src/types/plugin.js';

describe('MyPlugin', () => {
  let plugin: MyPlugin;
  let manifest: PluginManifest;
  let mockContext: PluginContext;

  beforeEach(() => {
    // å‡†å¤‡æ¸…å•
    manifest = {
      id: 'test-plugin',
      name: 'Test Plugin',
      version: '1.0.0',
      entry: 'dist/index.js',
      capabilities: [
        {
          type: 'custom',
          name: 'test',
          version: '1.0.0'
        }
      ]
    };

    // åˆ›å»ºæ¨¡æ‹Ÿä¸Šä¸‹æ–‡
    mockContext = createMockContext();

    // åˆ›å»ºæ’ä»¶å®ä¾‹
    plugin = new MyPlugin(manifest);
  });

  afterEach(() => {
    // æ¸…ç†
    plugin = undefined as any;
  });

  describe('åˆå§‹åŒ–', () => {
    it('åº”è¯¥æˆåŠŸåˆå§‹åŒ–', async () => {
      await plugin.initialize(mockContext);

      expect(plugin.status).toBe('loaded');
    });

    it('åº”è¯¥è®¾ç½®ä¸Šä¸‹æ–‡', async () => {
      await plugin.initialize(mockContext);

      expect((plugin as any).context).toBe(mockContext);
    });

    it('åº”è¯¥è®°å½•åˆå§‹åŒ–æ—¥å¿—', async () => {
      const logSpy = mock(() => {});
      mockContext.logger.info = logSpy;

      await plugin.initialize(mockContext);

      expect(logSpy).toHaveBeenCalled();
    });
  });

  describe('æ¿€æ´»', () => {
    beforeEach(async () => {
      await plugin.initialize(mockContext);
    });

    it('åº”è¯¥æˆåŠŸæ¿€æ´»', async () => {
      await plugin.activate();

      expect(plugin.status).toBe('active');
    });

    it('åº”è¯¥è®°å½•æ¿€æ´»æ—¥å¿—', async () => {
      const logSpy = mock(() => {});
      mockContext.logger.info = logSpy;

      await plugin.activate();

      expect(logSpy).toHaveBeenCalled();
    });
  });

  describe('åœç”¨', () => {
    beforeEach(async () => {
      await plugin.initialize(mockContext);
      await plugin.activate();
    });

    it('åº”è¯¥æˆåŠŸåœç”¨', async () => {
      await plugin.deactivate();

      expect(plugin.status).toBe('inactive');
    });
  });

  describe('é”€æ¯', () => {
    it('åº”è¯¥æ¸…ç†ä¸Šä¸‹æ–‡', async () => {
      await plugin.initialize(mockContext);
      await plugin.dispose();

      expect((plugin as any).context).toBeUndefined();
    });
  });
});

/**
 * åˆ›å»ºæ¨¡æ‹Ÿä¸Šä¸‹æ–‡
 */
function createMockContext(): PluginContext {
  return {
    app: {
      version: '1.0.0',
      environment: 'development',
      rootPath: '/test',
      configPath: '/test/config'
    },
    services: {} as any,
    events: {
      on: mock(() => ({ dispose: mock(() => {}) })),
      once: mock(() => ({ dispose: mock(() => {}) })),
      emit: mock(() => {}),
      off: mock(() => {}),
      onAny: mock(() => ({ dispose: mock(() => {}) }))
    },
    logger: {
      debug: mock(() => {}),
      info: mock(() => {}),
      warn: mock(() => {}),
      error: mock(() => {})
    },
    storage: {
      get: mock(() => undefined),
      set: mock(() => {}),
      remove: mock(() => {}),
      clear: mock(() => {}),
      has: mock(() => false),
      keys: mock(() => []),
      size: 0
    },
    utils: {
      loadScript: mock(() => Promise.resolve()),
      loadStyles: mock(() => {}),
      deepClone: mock((obj: any) => JSON.parse(JSON.stringify(obj))),
      merge: mock((a: any, b: any) => ({ ...a, ...b })),
      debounce: mock((fn: any, delay: number) => fn),
      throttle: mock((fn: any, limit: number) => fn)
    },
    config: {
      get: mock(() => undefined),
      set: mock(() => {}),
      getAll: mock(() => ({})),
      onChange: mock(() => ({ dispose: mock(() => {}) }))
    }
  };
}
```

#### æµ‹è¯•æ¸²æŸ“å™¨

`tests/renderer.test.ts`

```typescript
import { describe, it, expect } from 'bun:test';
import { MyRenderer } from '../src/renderer';

describe('MyRenderer', () => {
  let renderer: MyRenderer;
  let mockContext: any;

  beforeEach(() => {
    mockContext = createMockContext();
    renderer = new MyRenderer(mockContext);
  });

  describe('canRender', () => {
    it('åº”è¯¥è¯†åˆ«æ”¯æŒçš„å†…å®¹', () => {
      const content = '```my-format\nHello\n```';
      expect(renderer.canRender(content)).toBe(true);
    });

    it('åº”è¯¥æ‹’ç»ä¸æ”¯æŒçš„å†…å®¹', () => {
      const content = '```javascript\nconsole.log("Hello");\n```';
      expect(renderer.canRender(content)).toBe(false);
    });
  });

  describe('render', () => {
    it('åº”è¯¥æˆåŠŸæ¸²æŸ“å†…å®¹', async () => {
      const content = '```my-format\nHello World\n```';
      const result = await renderer.render(content);

      expect(result).toContain('Hello World');
    });

    it('åº”è¯¥å¤„ç†æ¸²æŸ“é”™è¯¯', async () => {
      const invalidContent = '```my-format\n[invalid]\n```';

      await expect(renderer.render(invalidContent)).rejects.toThrow();
    });

    it('åº”è¯¥ä½¿ç”¨é€‰é¡¹æ¸²æŸ“', async () => {
      const content = '```my-format\nHello\n```';
      const options = { theme: 'dark' };

      const result = await renderer.render(content, options);

      expect(result).toContain('dark');
    });
  });

  describe('ç¼“å­˜', () => {
    it('åº”è¯¥ç¼“å­˜æ¸²æŸ“ç»“æœ', async () => {
      const content = '```my-format\nHello\n```';

      await renderer.render(content, { cache: true });
      const result = await renderer.render(content, { cache: true });

      // éªŒè¯æ¥è‡ªç¼“å­˜
      expect(result).toBeDefined();
    });

    it('åº”è¯¥æ¸…é™¤ç¼“å­˜', async () => {
      renderer.clearCache();

      expect(renderer.getCacheSize()).toBe(0);
    });
  });
});
```

### é›†æˆæµ‹è¯•

#### æµ‹è¯•æ’ä»¶é›†æˆ

`tests/integration.test.ts`

```typescript
import { describe, it, expect, beforeAll, afterAll } from 'bun:test';
import { PluginManager } from '../src/plugin-manager';

describe('Plugin Integration', () => {
  let manager: PluginManager;

  beforeAll(async () => {
    // åˆå§‹åŒ–æ’ä»¶ç®¡ç†å™¨
    manager = new PluginManager({
      pluginPaths: ['./plugins'],
      enabled: true,
      autoActivate: true,
      logLevel: 'debug'
    });

    // åŠ è½½æ’ä»¶
    await manager.loadPlugins();
  });

  afterAll(async () => {
    // æ¸…ç†
    await manager.dispose();
  });

  describe('æ’ä»¶åŠ è½½', () => {
    it('åº”è¯¥åŠ è½½æ‰€æœ‰æ’ä»¶', async () => {
      const plugins = manager.getAllPlugins();

      expect(plugins.length).toBeGreaterThan(0);
    });

    it('åº”è¯¥æ¿€æ´»æ’ä»¶', async () => {
      const plugins = manager.getAllPlugins();
      const activePlugins = plugins.filter(p => p.status === 'active');

      expect(activePlugins.length).toBeGreaterThan(0);
    });
  });

  describe('æ’ä»¶é€šä¿¡', () => {
    it('åº”è¯¥æ¥æ”¶äº‹ä»¶', async () => {
      let eventReceived = false;

      // è®¢é˜…äº‹ä»¶
      manager.events.on('test:event', () => {
        eventReceived = true;
      });

      // å‘å¸ƒäº‹ä»¶
      manager.events.emit('test:event', {});

      // ç­‰å¾…äº‹ä»¶å¤„ç†
      await new Promise(resolve => setTimeout(resolve, 100));

      expect(eventReceived).toBe(true);
    });
  });

  describe('æ’ä»¶ä¾èµ–', () => {
    it('åº”è¯¥è§£æä¾èµ–', async () => {
      const plugin = manager.getPlugin('plugin-a');

      expect(plugin).toBeDefined();

      // æ£€æŸ¥ä¾èµ–æ˜¯å¦å·²åŠ è½½
      const dependency = manager.getPlugin('plugin-b');
      expect(dependency).toBeDefined();
    });
  });
});
```

### æµ‹è¯•æœ€ä½³å®è·µ

#### 1. ä½¿ç”¨æµ‹è¯•æ›¿èº«

```typescript
// ä½¿ç”¨ mock å¯¹è±¡
const mockLogger = {
  debug: mock(() => {}),
  info: mock(() => {}),
  warn: mock(() => {}),
  error: mock(() => {})
};

// ä½¿ç”¨ spy
const originalMethod = plugin.someMethod;
plugin.someMethod = mock((...args) => originalMethod.apply(plugin, args));

// éªŒè¯è°ƒç”¨
expect(mockLogger.info).toHaveBeenCalledWith('Plugin initialized');
expect(plugin.someMethod).toHaveBeenCalledTimes(1);
```

#### 2. æµ‹è¯•å¼‚æ­¥ä»£ç 

```typescript
it('åº”è¯¥å¤„ç†å¼‚æ­¥æ“ä½œ', async () => {
  const promise = plugin.initialize(mockContext);

  // ç­‰å¾… Promise å®Œæˆ
  await expect(promise).resolves.not.toThrow();

  // éªŒè¯çŠ¶æ€
  expect(plugin.status).toBe('loaded');
});

it('åº”è¯¥æ‹’ç»é”™è¯¯çš„ Promise', async () => {
  const promise = plugin.initialize(null as any);

  await expect(promise).rejects.toThrow();
});
```

#### 3. æµ‹è¯•é”™è¯¯å¤„ç†

```typescript
it('åº”è¯¥å¤„ç†é”™è¯¯', async () => {
  // æ¨¡æ‹Ÿé”™è¯¯
  mockContext.services.fileService.readFile = mock(() => {
    throw new Error('File not found');
  });

  // éªŒè¯é”™è¯¯å¤„ç†
  await expect(plugin.initialize(mockContext)).rejects.toThrow('File not found');

  // éªŒè¯é”™è¯¯æ—¥å¿—
  expect(mockContext.logger.error).toHaveBeenCalled();
});
```

#### 4. æµ‹è¯•è¾¹ç•Œæ¡ä»¶

```typescript
it('åº”è¯¥å¤„ç†ç©ºè¾“å…¥', async () => {
  const result = await renderer.render('');

  expect(result).toBe('');
});

it('åº”è¯¥å¤„ç†æå¤§è¾“å…¥', async () => {
  const largeContent = 'x'.repeat(1000000);

  const result = await renderer.render(largeContent);

  expect(result.length).toBeGreaterThan(0);
});

it('åº”è¯¥å¤„ç†ç‰¹æ®Šå­—ç¬¦', async () => {
  const specialContent = '```my-format\n<>&"\'\n```';

  const result = await renderer.render(specialContent);

  expect(result).toContain('&lt;');
});
```

#### 5. ä½¿ç”¨å¿«ç…§æµ‹è¯•

```typescript
it('åº”è¯¥åŒ¹é…å¿«ç…§', async () => {
  const content = '```my-format\nHello World\n```';
  const result = await renderer.render(content);

  expect(result).toMatchSnapshot();
});
```

---

## å‘å¸ƒæŒ‡å—

### æ’ä»¶æ‰“åŒ…å’Œç‰ˆæœ¬ç®¡ç†

#### ç‰ˆæœ¬å·è§„èŒƒ

éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼ˆsemverï¼‰è§„èŒƒï¼š

- `MAJOR.MINOR.PATCH`ï¼ˆä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢ç‰ˆæœ¬ï¼‰
- ä¸»ç‰ˆæœ¬ï¼šä¸å…¼å®¹çš„ API å˜æ›´
- æ¬¡ç‰ˆæœ¬ï¼šå‘åå…¼å®¹çš„åŠŸèƒ½æ–°å¢
- ä¿®è®¢ç‰ˆæœ¬ï¼šå‘åå…¼å®¹çš„é—®é¢˜ä¿®å¤

#### æ›´æ–°ç‰ˆæœ¬å·

```bash
# æ›´æ–°ä¿®è®¢ç‰ˆæœ¬ï¼ˆ1.0.0 -> 1.0.1ï¼‰
npm version patch

# æ›´æ–°æ¬¡ç‰ˆæœ¬ï¼ˆ1.0.0 -> 1.1.0ï¼‰
npm version minor

# æ›´æ–°ä¸»ç‰ˆæœ¬ï¼ˆ1.0.0 -> 2.0.0ï¼‰
npm version major

# é¢„å‘å¸ƒç‰ˆæœ¬ï¼ˆ1.0.0 -> 1.0.0-beta.1ï¼‰
npm version prerelease --preid=beta
```

#### æ„å»ºæ’ä»¶

```bash
# æ¸…ç†æ—§æ„å»º
npm run clean

# è¿è¡Œç±»å‹æ£€æŸ¥
npm run typecheck

# è¿è¡Œæµ‹è¯•
npm test

# æ„å»ºæ’ä»¶
npm run build

# éªŒè¯æ„å»ºè¾“å‡º
ls -la dist/
```

#### æ‰“åŒ…æ’ä»¶

```bash
# åˆ›å»º npm åŒ…
npm pack

# è¾“å‡º: my-plugin-1.0.0.tgz
```

### æ–‡æ¡£ç¼–å†™è¦æ±‚

#### README.md ç»“æ„

```markdown
# My Plugin

> æ’ä»¶ç®€çŸ­æè¿°

## åŠŸèƒ½ç‰¹æ€§

- åŠŸèƒ½ 1
- åŠŸèƒ½ 2
- åŠŸèƒ½ 3

## å®‰è£…

\`\`\`bash
npm install my-plugin
\`\`\`

## é…ç½®

åœ¨ `folder-site.config.json` ä¸­æ·»åŠ ï¼š

\`\`\`json
{
  "plugins": ["my-plugin"],
  "my-plugin": {
    "option1": "value1",
    "option2": "value2"
  }
}
\`\`\`

## ä½¿ç”¨

\`\`\`markdown
\`\`\`my-format
å†…å®¹
\`\`\`
\`\`\`

## é€‰é¡¹

| é€‰é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | æè¿° |
|------|------|--------|------|
| option1 | string | "default" | é€‰é¡¹ 1 æè¿° |
| option2 | number | 100 | é€‰é¡¹ 2 æè¿° |

## API

### æ–¹æ³•

\`\`\`typescript
plugin.methodName(options)
\`\`\`

#### å‚æ•°

- \`options\`: é…ç½®é€‰é¡¹

#### è¿”å›å€¼

- \`Promise<Result>\`: å¤„ç†ç»“æœ

## ç¤ºä¾‹

\`\`\`typescript
import { MyPlugin } from 'my-plugin';

const plugin = new MyPlugin();
await plugin.initialize(context);
\`\`\`

## è®¸å¯è¯

MIT

## ä½œè€…

Your Name

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼
```

#### API æ–‡æ¡£

ä¸ºå…¬å…± API æ·»åŠ  JSDoc æ³¨é‡Šï¼š

```typescript
/**
 * æ¸²æŸ“å™¨ç±»
 *
 * @example
 * ```typescript
 * const renderer = new MyRenderer(context);
 * const result = await renderer.render(content);
 * ```
 */
export class MyRenderer {
  /**
   * æ£€æŸ¥æ˜¯å¦å¯ä»¥æ¸²æŸ“æŒ‡å®šå†…å®¹
   *
   * @param content - è¦æ£€æŸ¥çš„å†…å®¹
   * @returns æ˜¯å¦å¯ä»¥æ¸²æŸ“
   *
   * @example
   * ```typescript
   * if (renderer.canRender(content)) {
   *   const result = await renderer.render(content);
   * }
   * ```
   */
  canRender(content: string): boolean {
    // å®ç°
  }

  /**
   * æ¸²æŸ“å†…å®¹
   *
   * @param content - è¦æ¸²æŸ“çš„å†…å®¹
   * @param options - æ¸²æŸ“é€‰é¡¹
   * @returns æ¸²æŸ“ç»“æœ
   * @throws {Error} å¦‚æœæ¸²æŸ“å¤±è´¥
   *
   * @example
   * ```typescript
   * const result = await renderer.render(content, {
   *   theme: 'dark',
   *   format: 'svg'
   * });
   * ```
   */
  async render(
    content: string,
    options?: RenderOptions
  ): Promise<string> {
    // å®ç°
  }
}
```

### å‘å¸ƒæµç¨‹å’Œæ¸…å•

#### å‘å¸ƒå‰æ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ç±»å‹æ£€æŸ¥æ— é”™è¯¯
- [ ] ä»£ç å·²æ ¼å¼åŒ–
- [ ] æ–‡æ¡£å·²æ›´æ–°
- [ ] ç‰ˆæœ¬å·å·²æ›´æ–°
- [ ] CHANGELOG.md å·²æ›´æ–°
- [ ] README.md åŒ…å«ä½¿ç”¨ç¤ºä¾‹
- [ ] è®¸å¯è¯æ–‡ä»¶å·²åŒ…å«
- [ ] `.npmignore` å·²é…ç½®

#### å‘å¸ƒåˆ° npm

```bash
# 1. ç™»å½• npm
npm login

# 2. æ£€æŸ¥åŒ…åæ˜¯å¦å¯ç”¨
npm view my-plugin

# 3. å‘å¸ƒåŒ…
npm publish

# 4. å‘å¸ƒå¸¦æ ‡ç­¾çš„ç‰ˆæœ¬
npm publish --tag beta

# 5. å‘å¸ƒç§æœ‰åŒ…
npm publish --access restricted
```

#### å‘å¸ƒåˆ°æœ¬åœ°

```bash
# 1. æ‰“åŒ…æ’ä»¶
npm pack

# 2. åœ¨é¡¹ç›®ä¸­å®‰è£…æœ¬åœ°åŒ…
cd /path/to/folder-site
npm install /path/to/my-plugin/my-plugin-1.0.0.tgz
```

#### å‘å¸ƒåˆ° GitHub Releases

```bash
# 1. åˆ›å»º Git æ ‡ç­¾
git tag -a v1.0.0 -m "Release v1.0.0"

# 2. æ¨é€æ ‡ç­¾
git push origin v1.0.0

# 3. åœ¨ GitHub ä¸Šåˆ›å»º Release
# ä¸Šä¼ æ‰“åŒ…æ–‡ä»¶: my-plugin-1.0.0.tgz
```

### åˆ†å‘æ¸ é“

#### npm å…¬å…±ä»“åº“

```json
{
  "name": "@folder-site/my-plugin",
  "version": "1.0.0",
  "publishConfig": {
    "access": "public"
  }
}
```

#### npm ç§æœ‰ä»“åº“

```json
{
  "name": "@company/my-plugin",
  "publishConfig": {
    "access": "restricted",
    "registry": "https://npm.company.com"
  }
}
```

#### GitHub Packages

```json
{
  "publishConfig": {
    "registry": "https://npm.pkg.github.com"
  }
}
```

#### ç›´æ¥ä¸‹è½½

æä¾›ä¸‹è½½é“¾æ¥ï¼š

```markdown
## ä¸‹è½½

- [v1.0.0](https://github.com/user/my-plugin/releases/download/v1.0.0/my-plugin-1.0.0.tgz)
- [v1.0.0-beta.1](https://github.com/user/my-plugin/releases/download/v1.0.0-beta.1/my-plugin-1.0.0-beta.1.tgz)
```

---

## é™„å½•

### API å¿«é€Ÿå‚è€ƒ

#### Plugin æ¥å£

```typescript
interface Plugin {
  readonly id: string;
  readonly name: string;
  readonly version: string;
  readonly manifest: PluginManifest;
  readonly status: PluginStatus;
  readonly error?: Error;

  initialize(context: PluginContext): Promise<void>;
  activate(): Promise<void>;
  deactivate(): Promise<void>;
  dispose(): Promise<void>;
}
```

#### PluginContext æ¥å£

```typescript
interface PluginContext {
  readonly app: {
    readonly version: string;
    readonly environment: 'development' | 'production';
    readonly rootPath: string;
    readonly configPath: string;
  };
  readonly services: PluginServices;
  readonly events: PluginEventEmitter;
  readonly logger: PluginLogger;
  readonly storage: PluginStorage;
  readonly utils: PluginUtils;
  readonly config: PluginConfig;
}
```

#### äº‹ä»¶ç³»ç»Ÿ

```typescript
interface PluginEventEmitter {
  on<T>(event: string, handler: (data: T) => void): Disposable;
  once<T>(event: string, handler: (data: T) => void): Disposable;
  emit<T>(event: string, data: T): void;
  off(event: string, handler: (data: unknown) => void): void;
  onAny(handler: (event: string, data: unknown) => void): Disposable;
}
```

#### æ—¥å¿—ç³»ç»Ÿ

```typescript
interface PluginLogger {
  debug(message: string, ...args: unknown[]): void;
  info(message: string, ...args: unknown[]): void;
  warn(message: string, ...args: unknown[]): void;
  error(message: string, ...args: unknown[]): void;
}
```

#### å­˜å‚¨ç³»ç»Ÿ

```typescript
interface PluginStorage {
  get<T>(key: string, defaultValue?: T): T | undefined;
  set<T>(key: string, value: T): void;
  remove(key: string): void;
  clear(): void;
  has(key: string): boolean;
  keys(): string[];
  readonly size: number;
}
```

### å¸¸ç”¨å‘½ä»¤

#### å¼€å‘å‘½ä»¤

```bash
# å®‰è£…ä¾èµ–
npm install

# æ„å»ºæ’ä»¶
npm run build

# ç›‘å¬æ¨¡å¼æ„å»º
npm run dev

# è¿è¡Œæµ‹è¯•
npm test

# ç±»å‹æ£€æŸ¥
npm run typecheck

# ä»£ç æ£€æŸ¥
npm run lint

# æ¸…ç†æ„å»º
npm run clean
```

#### å‘å¸ƒå‘½ä»¤

```bash
# æ›´æ–°ç‰ˆæœ¬
npm version patch
npm version minor
npm version major

# æ‰“åŒ…
npm pack

# å‘å¸ƒ
npm publish
npm publish --tag beta
```

#### Git å‘½ä»¤

```bash
# åˆ›å»ºæ ‡ç­¾
git tag -a v1.0.0 -m "Release v1.0.0"

# æ¨é€æ ‡ç­¾
git push origin v1.0.0

# åˆ—å‡ºæ ‡ç­¾
git tag -l
```

### èµ„æºé“¾æ¥

#### å®˜æ–¹æ–‡æ¡£

- [Folder-Site ä¸»é¡µ](https://github.com/folder-site/folder-site)
- [æ’ä»¶ API æ–‡æ¡£](./PLUGIN_API.md)
- [æ’ä»¶å¼€å‘æŒ‡å—](./PLUGIN_DEVELOPMENT.md)
- [æ’ä»¶æ¶æ„](./plugin-architecture.md)

#### ç›¸å…³èµ„æº

- [TypeScript æ–‡æ¡£](https://www.typescriptlang.org/docs/)
- [Node.js æ–‡æ¡£](https://nodejs.org/docs/)
- [Bun æ–‡æ¡£](https://bun.sh/docs)
- [npm æ–‡æ¡£](https://docs.npmjs.com/)

#### ç¤ºä¾‹æ’ä»¶

- [Mermaid æ¸²æŸ“å™¨](../plugins/mermaid-renderer)
- [Vega æ¸²æŸ“å™¨](../plugins/vega-renderer)
- [Graphviz æ¸²æŸ“å™¨](../plugins/graphviz-renderer)
- [JSON Canvas æ¸²æŸ“å™¨](../plugins/json-canvas-renderer)

#### ç¤¾åŒºèµ„æº

- [GitHub Issues](https://github.com/folder-site/folder-site/issues)
- [GitHub Discussions](https://github.com/folder-site/folder-site/discussions)
- [Contributing Guide](./CONTRIBUTING.md)

#### å·¥å…·å’Œåº“

- [JSDoc](https://jsdoc.app/)
- [ESLint](https://eslint.org/)
- [Prettier](https://prettier.io/)
- [Husky](https://typicode.github.io/husky/)

---

## æ€»ç»“

æ­å–œï¼ä½ å·²ç»å®Œæˆäº† Folder-Site æ’ä»¶å¼€å‘æ•™ç¨‹çš„å­¦ä¹ ã€‚ç°åœ¨ä½ åº”è¯¥èƒ½å¤Ÿï¼š

1. âœ… åˆ›å»ºåŸºæœ¬çš„æ’ä»¶é¡¹ç›®ç»“æ„
2. âœ… å®ç°æ’ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
3. âœ… ä½¿ç”¨æ’ä»¶ API å’Œä¸Šä¸‹æ–‡
4. âœ… å®ç°å¸¸è§çš„æ’ä»¶æ¨¡å¼
5. âœ… å¤„ç†æ’ä»¶é—´é€šä¿¡
6. âœ… ç®¡ç†æ’ä»¶é…ç½®å’Œä¾èµ–
7. âœ… ä¼˜åŒ–æ’ä»¶æ€§èƒ½
8. âœ… è°ƒè¯•å’Œæµ‹è¯•æ’ä»¶
9. âœ… æ‰“åŒ…å’Œå‘å¸ƒæ’ä»¶

### ä¸‹ä¸€æ­¥

- æŸ¥çœ‹[ç¤ºä¾‹æ’ä»¶](../plugins/)äº†è§£æ›´å¤šå®ç°ç»†èŠ‚
- é˜…è¯»[æ’ä»¶ API æ–‡æ¡£](./PLUGIN_API.md)è·å–å®Œæ•´çš„ API å‚è€ƒ
- åŠ å…¥ç¤¾åŒºï¼Œåˆ†äº«ä½ çš„æ’ä»¶

### è·å–å¸®åŠ©

å¦‚æœä½ åœ¨å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹[FAQ](./FAQ.md)
2. æœç´¢[GitHub Issues](https://github.com/folder-site/folder-site/issues)
3. åœ¨[GitHub Discussions](https://github.com/folder-site/folder-site/discussions)æé—®
4. è”ç³»ç»´æŠ¤è€…

ç¥ä½ å¼€å‘æ„‰å¿«ï¼ğŸ‰