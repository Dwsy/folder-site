---
id: "2026-01-24-分析信息图渲染功能实现"
title: "分析并实现 Infographic 信息图渲染功能"
status: "in-progress"
created: "2026-01-24"
updated: "2026-01-24"
category: "analysis"
tags: ["renderer", "infographic", "antv", "plugin"]
---

# Issue: 分析并实现 Infographic 信息图渲染功能

## Goal

实现基于 AntV Infographic 的信息图渲染插件，使前端 Markdown 能够渲染 infographic 代码块。

## 背景/问题

### 当前状态
1. **文档中提到但未实现**：`docs/technical-spec.md` 中详细描述了 InfographicRenderer 的设计，但实际代码中不存在
2. **缺少依赖**：`package.json` 中没有 `@antv/infographic` 依赖
3. **插件目录缺失**：`plugins/` 目录下没有 `infographic-renderer` 文件夹
4. **前端无法渲染**：Markdown 中的 infographic 代码块无法被识别和渲染

### 现有渲染器架构
项目已有完善的插件系统和渲染器架构：
- **插件接口**：`src/types/plugin.ts` 定义了 `Plugin` 和 `RendererPlugin` 接口
- **插件注册表**：`src/server/lib/plugin-registry.ts` 管理插件生命周期
- **现有渲染器**：
  - `plugins/mermaid-renderer/` - Mermaid 图表渲染
  - `plugins/vega-renderer/` - Vega/Vega-Lite 数据可视化
  - `plugins/graphviz-renderer/` - Graphviz DOT 图渲染
  - `plugins/json-canvas-renderer/` - JSON Canvas 渲染
  - `plugins/office-renderer/` - Office 文档渲染（PDF/Excel/Word）

### 技术规格（来自文档）
根据 `docs/technical-spec.md` 的描述，InfographicRenderer 应具备：

1. **DSL 语法支持**：缩进式 DSL 而非 JSON
   ```
   infographic scorecard
   data
     title 季度销售报告
     items
       - label 总销售额
         value 1,234,567
       - label 同比增长
         value +15.2%
   ```

2. **异步渲染与事件驱动**：
   - 使用 Promise 包装事件监听
   - 10 秒超时限制
   - 监听 `rendered` 和 `error` 事件

3. **资源嵌入技术**：
   - 导出 SVG 时启用 `embedResources: true`
   - 嵌入字体、图标等外部资源

4. **错误信息优化**：
   - 格式化解析错误信息
   - 提供友好的语法提示

## 验收标准 (Acceptance Criteria)

- [x] WHEN 分析现有渲染器架构，系统 SHALL 提供清晰的实现模式参考
- [ ] WHEN 安装 @antv/infographic 依赖，系统 SHALL 成功添加到 package.json
- [ ] WHEN 创建 InfographicRenderer 类，系统 SHALL 实现 RendererPlugin 接口
- [ ] WHEN 创建 InfographicRendererPlugin 类，系统 SHALL 实现 Plugin 接口
- [ ] WHEN 在 Markdown 中使用 infographic 代码块，系统 SHALL 正确渲染为 SVG
- [ ] WHEN 渲染失败，系统 SHALL 提供友好的错误提示
- [ ] WHEN 渲染超时（>10s），系统 SHALL 抛出超时错误
- [ ] WHERE 导出 SVG，系统 SHALL 嵌入所有外部资源（字体、图标）

## 实施阶段

### Phase 1: 规划和准备 ✅
- [x] 分析现有渲染器架构
- [x] 查看 Mermaid/Vega 渲染器实现模式
- [x] 确认插件接口和注册流程
- [x] 研究 @antv/infographic API

### Phase 2: 依赖和结构
- [ ] 安装 @antv/infographic 依赖
- [ ] 创建 `plugins/infographic-renderer/` 目录
- [ ] 创建基础文件结构：
  - `InfographicRenderer.ts` - 核心渲染器
  - `index.ts` - 插件入口
  - `manifest.json` - 插件清单
  - `README.md` - 使用文档

### Phase 3: 核心实现
- [ ] 实现 InfographicRenderer 类
  - [ ] 实现 render() 方法
  - [ ] 实现事件驱动渲染逻辑
  - [ ] 实现超时处理
  - [ ] 实现资源嵌入
  - [ ] 实现错误格式化
- [ ] 实现 InfographicRendererPlugin 类
  - [ ] 实现 initialize() 方法
  - [ ] 实现 activate() 方法
  - [ ] 实现 deactivate() 方法
  - [ ] 实现 dispose() 方法

### Phase 4: 集成和测试
- [ ] 在插件注册表中注册渲染器
- [ ] 测试基本渲染功能
- [ ] 测试错误处理
- [ ] 测试超时机制
- [ ] 测试资源嵌入

### Phase 5: 文档和交付
- [ ] 编写使用文档
- [ ] 添加示例代码
- [ ] 更新 README.md
- [ ] 创建测试用例

## 关键决策

| 决策 | 理由 |
|------|------|
| 使用 @antv/infographic 库 | 文档中已明确指定，且 AntV 是成熟的可视化库 |
| 参考 MermaidRenderer 实现模式 | Mermaid 和 Infographic 都是 DSL 语法，渲染流程相似 |
| 10 秒超时限制 | 与文档规格一致，防止渲染卡死 |
| 嵌入外部资源 | 确保导出的 SVG 独立完整，可在任何环境显示 |
| 插件化架构 | 遵循项目现有架构，便于维护和扩展 |

## 现有渲染器实现模式分析

### 1. RendererPlugin 接口
```typescript
export interface RendererPlugin {
  name: string;                    // 渲染器名称
  extensions: string[];            // 支持的文件扩展名
  version?: string;                // 版本号
  priority?: PluginPriority;       // 优先级
  pluginId?: string;               // 所属插件 ID
  
  render(content: string, options?: Record<string, unknown>): Promise<string>;
  canRender?(content: string): boolean;
  onRegister?(): Promise<void>;
  onUnregister?(): Promise<void>;
}
```

### 2. Plugin 接口
```typescript
export interface Plugin {
  readonly id: string;
  readonly name: string;
  readonly version: string;
  readonly manifest: PluginManifest;
  readonly status: PluginStatus;
  readonly error?: Error;
  
  initialize(context: PluginContext): Promise<void>;
  activate(): Promise<void>;
  deactivate(): Promise<void>;
  dispose(): Promise<void>;
}
```

### 3. 典型实现结构（参考 MermaidRenderer）

**文件结构：**
```
plugins/mermaid-renderer/
├── MermaidRenderer.ts    # 核心渲染器实现
├── index.ts              # 插件入口
├── manifest.json         # 插件清单
└── README.md             # 文档
```

**MermaidRenderer.ts 关键点：**
- 实现 `RendererPlugin` 接口
- 提供 `render()` 方法
- 支持主题配置
- 支持多种输出格式（SVG/PNG）
- 缓存机制
- 错误处理

**index.ts 关键点：**
- 实现 `Plugin` 接口
- 在 `initialize()` 中创建渲染器实例
- 在 `activate()` 中注册渲染器
- 管理插件生命周期

## 遇到的错误

| 日期 | 错误 | 解决方案 |
|------|------|---------|
| 2026-01-24 | 文档与实现不一致 | 确认实际未实现，需要从零开发 |

## 相关资源

- [x] 相关文档: `docs/technical-spec.md` - InfographicRenderer 设计规格
- [x] 相关文档: `docs/plugin-architecture.md` - 插件架构说明
- [x] 参考实现: `plugins/mermaid-renderer/` - Mermaid 渲染器
- [x] 参考实现: `plugins/vega-renderer/` - Vega 渲染器
- [x] 类型定义: `src/types/plugin.ts` - 插件接口定义
- [x] 注册表: `src/server/lib/plugin-registry.ts` - 插件注册逻辑
- [ ] 外部库: [@antv/infographic](https://github.com/antvis/infographic) - AntV 信息图库

## Notes

### 架构分析总结

1. **插件系统成熟**：项目已有完善的插件架构，只需按照现有模式实现即可
2. **渲染器模式统一**：所有渲染器都遵循相同的接口和生命周期
3. **参考实现充足**：可以参考 MermaidRenderer 的实现，两者渲染流程相似
4. **文档规格清晰**：技术文档已明确定义了 InfographicRenderer 的功能需求

### 实现优先级

1. **高优先级**：
   - 安装依赖
   - 实现基本渲染功能
   - 实现插件注册

2. **中优先级**：
   - 错误处理
   - 超时机制
   - 资源嵌入

3. **低优先级**：
   - 缓存机制
   - 性能优化
   - 高级配置

### 待确认事项

- [ ] @antv/infographic 的最新版本和 API 变化
- [ ] 是否需要在浏览器和 Node.js 环境都支持
- [ ] 是否需要支持 PNG 输出（文档只提到 SVG）
- [ ] 缓存策略是否与其他渲染器一致

---

## Status 更新日志

- **2026-01-24 01:12**: 状态变更 → in-progress，备注: 完成架构分析，明确实现方案