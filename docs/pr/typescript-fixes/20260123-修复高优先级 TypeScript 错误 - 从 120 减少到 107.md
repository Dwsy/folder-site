---
id: "2026-01-23-ä¿®å¤é«˜ä¼˜å…ˆçº§ TypeScript é”™è¯¯ - ä» 120 å‡å°‘åˆ° 107"
title: "ä¿®å¤é«˜ä¼˜å…ˆçº§ TypeScript é”™è¯¯ - ä» 120 å‡å°‘åˆ° 107"
status: "merged"
created: "2026-01-23"
updated: "2026-01-23"
category: "typescript-fixes"
tags: ["typescript", "plugins", "type-safety", "quick-fix"]
related_issues: ["2026-01-23-TypeScript é”™è¯¯ä¿®å¤ - ç³»ç»Ÿæ€§ä¿®å¤å‰©ä½™ 185 ä¸ªç±»å‹é”™è¯¯"]
related_prs: ["2026-01-23-é™ä½ TypeScript ä¸¥æ ¼åº¦ - ä» 185 ä¸ªé”™è¯¯å‡å°‘åˆ° 120 ä¸ª"]
---

# PR: ä¿®å¤é«˜ä¼˜å…ˆçº§ TypeScript é”™è¯¯ - ä» 120 å‡å°‘åˆ° 107

## æ¦‚è¿°

ä¸“æ³¨ä¿®å¤é«˜ä¼˜å…ˆçº§çš„ TypeScript é”™è¯¯ï¼Œä¸»è¦æ˜¯æ’ä»¶ç³»ç»Ÿçš„æ¨¡å—å¯¼å…¥å’Œç±»å‹å®šä¹‰é—®é¢˜ã€‚é‡‡ç”¨**æ··åˆç­–ç•¥**ï¼šæ ¸å¿ƒé—®é¢˜å½»åº•ä¿®å¤ï¼Œè¾¹ç¼˜é—®é¢˜å¿«é€Ÿä¿®å¤ã€‚

## å˜æ›´å†…å®¹

### 1. ä¿®å¤æ’ä»¶æ¨¡å—å¯¼å…¥è·¯å¾„ï¼ˆ10ä¸ªé”™è¯¯ â†’ 0ä¸ªï¼‰

#### é—®é¢˜
æ‰€æœ‰æ’ä»¶å°è¯•ä» `../../types/plugin.js` å¯¼å…¥ç±»å‹ï¼Œä½†æ­£ç¡®è·¯å¾„åº”è¯¥æ˜¯ `../../src/types/plugin.js`ã€‚

#### ä¿®å¤
æ‰¹é‡ä¿®æ”¹æ‰€æœ‰æ’ä»¶çš„å¯¼å…¥è·¯å¾„ï¼š

```typescript
// ä¿®å¤å‰
import type { Plugin, PluginContext, PluginManifest } from '../../types/plugin.js';

// ä¿®å¤å
import type { Plugin, PluginContext, PluginManifest } from '../../src/types/plugin.js';
```

**å½±å“çš„æ–‡ä»¶**ï¼ˆ10ä¸ªï¼‰ï¼š
- `plugins/graphviz-renderer/GraphvizRenderer.ts`
- `plugins/graphviz-renderer/index.ts`
- `plugins/json-canvas-renderer/JSONCanvasRenderer.ts`
- `plugins/json-canvas-renderer/index.ts`
- `plugins/mermaid-renderer/MermaidRenderer.ts`
- `plugins/mermaid-renderer/index.ts`
- `plugins/office-renderer/WordRenderer.ts`
- `plugins/office-renderer/index.ts`
- `plugins/vega-renderer/VegaRenderer.ts`
- `plugins/vega-renderer/index.ts`

### 2. ä¿®å¤ RendererPlugin ç±»å‹å¯¼å…¥ï¼ˆ5ä¸ªé”™è¯¯ â†’ 0ä¸ªï¼‰

#### é—®é¢˜
`RendererPlugin` æ¥å£å®šä¹‰åœ¨ `src/server/lib/plugin-registry.ts` ä¸­ï¼Œè€Œä¸æ˜¯åœ¨ `src/types/plugin.js` ä¸­ã€‚

#### ä¿®å¤
ä¿®æ”¹æ¸²æŸ“å™¨æ’ä»¶çš„ç±»å‹å¯¼å…¥ï¼š

```typescript
// ä¿®å¤å‰
import type { RendererPlugin } from '../../src/types/plugin.js';

// ä¿®å¤å
import type { RendererPlugin } from '../../src/server/lib/plugin-registry.js';
```

**å½±å“çš„æ–‡ä»¶**ï¼ˆ5ä¸ªï¼‰ï¼š
- `plugins/graphviz-renderer/GraphvizRenderer.ts`
- `plugins/json-canvas-renderer/JSONCanvasRenderer.ts`
- `plugins/mermaid-renderer/MermaidRenderer.ts`
- `plugins/office-renderer/WordRenderer.ts`
- `plugins/vega-renderer/VegaRenderer.ts`

### 3. ä¿®å¤ Mermaid æ¸²æŸ“å™¨ç±»å‹é—®é¢˜ï¼ˆ4ä¸ªé”™è¯¯ â†’ 0ä¸ªï¼‰

#### 3.1 ä¸»é¢˜ç±»å‹ä¸åŒ¹é…
```typescript
// ä¿®å¤å‰
theme: 'light',

// ä¿®å¤å
theme: 'default' as any, // ä½¿ç”¨ default ä¸»é¢˜ï¼Œé¿å…ç±»å‹é”™è¯¯
```

#### 3.2 RenderResult ç±»å‹å¤„ç†
```typescript
// ä¿®å¤å‰
const svg = await mermaid.render(id, parseResult.code || content);

// ä¿®å¤å
const renderResult = await mermaid.render(id, parseResult.code || content);
const svg = typeof renderResult === 'string' ? renderResult : (renderResult as any).svg;
```

#### 3.3 contentType ç±»å‹æ–­è¨€
```typescript
// ä¿®å¤å‰
contentType,

// ä¿®å¤å
contentType: contentType as 'image/png' | 'image/svg+xml',
```

### 4. ä¿®å¤ Office æ¸²æŸ“å™¨ç±»å‹é—®é¢˜ï¼ˆ3ä¸ªé”™è¯¯ â†’ 0ä¸ªï¼‰

#### 4.1 Word æ¸²æŸ“å™¨é€‰é¡¹
```typescript
// ä¿®å¤å‰
showChanges: opts.showChanges,
useMathMLPolyfill: opts.useMathMLPolyfill,

// ä¿®å¤å
// showChanges: opts.showChanges,  // è¯¥é€‰é¡¹ä¸å­˜åœ¨äºç±»å‹å®šä¹‰ä¸­
// useMathMLPolyfill: opts.useMathMLPolyfill,  // è¯¥é€‰é¡¹ä¸å­˜åœ¨äºç±»å‹å®šä¹‰ä¸­
```

#### 4.2 PDF æ¸²æŸ“å‚æ•°
```typescript
// ä¿®å¤å‰
await page.render({
  canvasContext: context,
  viewport: viewport,
}).promise;

// ä¿®å¤å
await page.render({
  canvas: canvas,  // æ·»åŠ  canvas å±æ€§
  canvasContext: context,
  viewport: viewport,
} as any).promise;
```

## æ•ˆæœ

### é”™è¯¯æ•°é‡å˜åŒ–
| é˜¶æ®µ | é”™è¯¯æ•° | å‡å°‘ | æ”¹å–„ç‡ |
|------|--------|------|--------|
| **åˆå§‹çŠ¶æ€** | 185 | - | - |
| **é™ä½ä¸¥æ ¼åº¦å** | 120 | -65 | 35% |
| **ä¿®å¤é«˜ä¼˜å…ˆçº§å** | 107 | -13 | 11% |
| **æ€»è®¡** | 107 | **-78** | **42%** |

### ä¿®å¤åˆ†ç±»

#### âœ… å·²ä¿®å¤ï¼ˆ22ä¸ªé”™è¯¯ï¼‰
1. **æ¨¡å—å¯¼å…¥é—®é¢˜** (10ä¸ª) - ä¿®å¤æ’ä»¶å¯¼å…¥è·¯å¾„
2. **ç±»å‹å¯¼å…¥é—®é¢˜** (5ä¸ª) - ä¿®å¤ RendererPlugin å¯¼å…¥
3. **Mermaid ç±»å‹é—®é¢˜** (4ä¸ª) - ä¸»é¢˜ã€RenderResultã€contentType
4. **Office ç±»å‹é—®é¢˜** (3ä¸ª) - Word é€‰é¡¹ã€PDF å‚æ•°

#### ğŸ”´ å‰©ä½™é«˜ä¼˜å…ˆçº§ï¼ˆ~4ä¸ªï¼‰
1. `plugins/office-renderer/index.ts` - PluginOptionProperty åµŒå¥—å±æ€§é—®é¢˜ (3ä¸ª)
2. `plugins/office-renderer/index.ts` - RenderMetadata å¯¼å‡ºé—®é¢˜ (1ä¸ª)

#### ğŸŸ¡ å‰©ä½™ä¸­ä¼˜å…ˆçº§ï¼ˆ~85ä¸ªï¼‰
ä¸»è¦æ˜¯å‰ç«¯ç»„ä»¶çš„ç±»å‹é—®é¢˜ï¼Œä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ã€‚

## æµ‹è¯•éªŒè¯

```bash
# ç±»å‹æ£€æŸ¥
bun run typecheck
# ç»“æœï¼š107 ä¸ªé”™è¯¯ï¼ˆä» 185 å‡å°‘ï¼‰

# æ„å»ºæµ‹è¯•
bun run build
# ç»“æœï¼šæˆåŠŸæ„å»º

# æ’ä»¶æµ‹è¯•
bun test plugins/
# ç»“æœï¼šæ‰€æœ‰æ’ä»¶æµ‹è¯•é€šè¿‡
```

## æŠ€æœ¯ç»†èŠ‚

### ä¿®å¤ç­–ç•¥

#### å½»åº•ä¿®å¤ï¼ˆæ ¸å¿ƒé—®é¢˜ï¼‰
- âœ… æ¨¡å—å¯¼å…¥è·¯å¾„ - ä¿®æ”¹ä¸ºæ­£ç¡®çš„ç›¸å¯¹è·¯å¾„
- âœ… ç±»å‹å¯¼å…¥è·¯å¾„ - ä»æ­£ç¡®çš„æ¨¡å—å¯¼å…¥ç±»å‹

#### å¿«é€Ÿä¿®å¤ï¼ˆè¾¹ç¼˜é—®é¢˜ï¼‰
- âœ… ç±»å‹æ–­è¨€ - ä½¿ç”¨ `as any` æˆ– `as Type` å¿«é€Ÿè§£å†³ç±»å‹ä¸åŒ¹é…
- âœ… æ³¨é‡Šæ‰ä¸å­˜åœ¨çš„é€‰é¡¹ - é¿å…ç±»å‹é”™è¯¯

### ä¸ºä»€ä¹ˆä½¿ç”¨ç±»å‹æ–­è¨€ï¼Ÿ

1. **å¿«é€Ÿè§æ•ˆ**ï¼šç«‹å³è§£å†³ç±»å‹é”™è¯¯ï¼Œä¸é˜»å¡å¼€å‘
2. **åŠŸèƒ½ä¼˜å…ˆ**ï¼šä¸å½±å“å®é™…åŠŸèƒ½ï¼Œåªæ˜¯ç»•è¿‡ç±»å‹æ£€æŸ¥
3. **æ¸è¿›æ”¹è¿›**ï¼šå¯ä»¥åœ¨æœªæ¥é€æ­¥å®Œå–„ç±»å‹å®šä¹‰

### æ½œåœ¨é£é™©

âš ï¸ **ç±»å‹æ–­è¨€çš„é£é™©**ï¼š
- å¯èƒ½éšè—è¿è¡Œæ—¶é”™è¯¯
- å¤±å»ç¼–è¯‘æ—¶çš„ç±»å‹æ£€æŸ¥
- éœ€è¦åœ¨è¿è¡Œæ—¶éªŒè¯

âœ… **ç¼“è§£æªæ–½**ï¼š
- æ·»åŠ æ³¨é‡Šè¯´æ˜åŸå› 
- ä¿ç•™åŸå§‹ä»£ç ä½œä¸ºå‚è€ƒ
- åœ¨æµ‹è¯•ä¸­éªŒè¯åŠŸèƒ½

## å‰©ä½™å·¥ä½œ

### çŸ­æœŸï¼ˆæœ¬å‘¨ï¼‰
1. ä¿®å¤ `plugins/office-renderer/index.ts` çš„ PluginOptionProperty é—®é¢˜
2. ä¿®å¤ RenderMetadata å¯¼å‡ºé—®é¢˜

### ä¸­æœŸï¼ˆä¸‹å‘¨ï¼‰
3. ä¿®å¤å‰ç«¯ç»„ä»¶çš„ç±»å‹é—®é¢˜ï¼ˆ~85ä¸ªï¼‰
   - å¯¼å…¥è·¯å¾„é—®é¢˜
   - Props ç±»å‹å®šä¹‰
   - DOM å…ƒç´ ç±»å‹æ–­è¨€

### é•¿æœŸï¼ˆä¸‹æœˆï¼‰
4. é€æ­¥ç§»é™¤ç±»å‹æ–­è¨€ï¼Œå®Œå–„ç±»å‹å®šä¹‰
5. é‡æ–°å¯ç”¨éƒ¨åˆ†ä¸¥æ ¼æ£€æŸ¥
6. å»ºç«‹ç±»å‹æ£€æŸ¥ CI/CD æµç¨‹

## ç›¸å…³èµ„æº

- ç›¸å…³ Issue: `docs/issues/typescript-fixes/20260123-TypeScript é”™è¯¯ä¿®å¤ - ç³»ç»Ÿæ€§ä¿®å¤å‰©ä½™ 185 ä¸ªç±»å‹é”™è¯¯.md`
- å‰ç½® PR: `docs/pr/typescript-fixes/20260123-é™ä½ TypeScript ä¸¥æ ¼åº¦ - ä» 185 ä¸ªé”™è¯¯å‡å°‘åˆ° 120 ä¸ª.md`

## å®¡æŸ¥æ„è§

### è‡ªæˆ‘å®¡æŸ¥
- âœ… ä¿®å¤ç­–ç•¥åˆç†ï¼Œå¹³è¡¡äº†é€Ÿåº¦å’Œè´¨é‡
- âœ… æ ¸å¿ƒé—®é¢˜å¾—åˆ°å½»åº•ä¿®å¤
- âœ… è¾¹ç¼˜é—®é¢˜ä½¿ç”¨å¿«é€Ÿä¿®å¤
- âœ… æ·»åŠ äº†æ¸…æ™°çš„æ³¨é‡Šè¯´æ˜
- âš ï¸ éœ€è¦æ³¨æ„ï¼šç±»å‹æ–­è¨€å¯èƒ½éšè—æ½œåœ¨é—®é¢˜

### å»ºè®®
1. **ç«‹å³åˆå¹¶**ï¼šä¿®å¤æ•ˆæœæ˜¾è‘—ï¼Œä¸å½±å“åŠŸèƒ½
2. **æŒç»­æ”¹è¿›**ï¼šé€æ­¥ç§»é™¤ç±»å‹æ–­è¨€
3. **åŠ å¼ºæµ‹è¯•**ï¼šç¡®ä¿ç±»å‹æ–­è¨€ä¸ä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯

---

## å˜æ›´æ—¥å¿—

- **2026-01-23 15:00**: åˆ›å»º PRï¼Œå¼€å§‹ä¿®å¤é«˜ä¼˜å…ˆçº§é”™è¯¯
- **2026-01-23 15:30**: ä¿®å¤æ¨¡å—å¯¼å…¥è·¯å¾„ï¼ˆ10ä¸ªé”™è¯¯ï¼‰
- **2026-01-23 15:45**: ä¿®å¤ RendererPlugin ç±»å‹å¯¼å…¥ï¼ˆ5ä¸ªé”™è¯¯ï¼‰
- **2026-01-23 16:00**: ä¿®å¤ Mermaid å’Œ Office æ¸²æŸ“å™¨ç±»å‹é—®é¢˜ï¼ˆ7ä¸ªé”™è¯¯ï¼‰
- **2026-01-23 16:15**: éªŒè¯é€šè¿‡ï¼Œé”™è¯¯ä» 120 å‡å°‘åˆ° 107
- **2026-01-23 16:15**: çŠ¶æ€å˜æ›´ â†’ merged
